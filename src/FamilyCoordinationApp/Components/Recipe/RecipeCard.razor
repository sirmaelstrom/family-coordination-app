@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Components.Shared

<MudCard Elevation="@(IsSelected ? 4 : 2)" 
         Class="@CardClass" 
         @onclick="HandleClick">
    <div class="recipe-image-container">
        @if (!string.IsNullOrWhiteSpace(Recipe.ImagePath))
        {
            <MudCardMedia Image="@Recipe.ImagePath" Height="200" />
        }
        else
        {
            <MudCardMedia Image="/images/recipe-placeholder.svg" Height="200" />
        }
        @if (!IsReadOnly)
        {
            <MudIconButton Icon="@(IsFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Outlined.FavoriteBorder)"
                           Color="@(IsFavorite ? Color.Error : Color.Default)"
                           Class="favorite-button"
                           Size="Size.Small"
                           OnClick="HandleFavoriteClick" />
        }
    </div>

    <MudCardContent Class="card-content">
        <div class="recipe-title-row">
            <MudText Typo="Typo.h6" Class="recipe-title">@Recipe.Name</MudText>
            <div class="recipe-badges">
                @if (Recipe.RecipeType != RecipeType.Main)
                {
                    <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(Recipe.RecipeType)" Variant="Variant.Outlined">
                        @GetTypeLabel(Recipe.RecipeType)
                    </MudChip>
                }
                @if (!string.IsNullOrWhiteSpace(Recipe.SourceUrl))
                {
                    <MudTooltip Text="Imported from web">
                        <MudIcon Icon="@Icons.Material.Filled.CloudDownload"
                                 Size="Size.Small"
                                 Color="Color.Secondary" />
                    </MudTooltip>
                }
            </div>
        </div>

        <div class="recipe-author">
            @if (Recipe.CreatedBy != null)
            {
                <UserAvatar User="@Recipe.CreatedBy" Size="Size.Small" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @Recipe.CreatedBy.DisplayName
                </MudText>
            }
            else
            {
                <MudAvatar Size="Size.Small" Color="Color.Default">
                    <MudIcon Icon="@Icons.Material.Filled.PersonOff" Size="Size.Small" />
                </MudAvatar>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="font-italic">
                    Deleted user
                </MudText>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(SharedFromHouseholdName))
        {
            <div class="recipe-attribution">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    From @SharedFromHouseholdName
                </MudText>
            </div>
        }

        <div class="recipe-ingredients">
            @if (Recipe.Ingredients.Any())
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @GetIngredientPreview()
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">
                    No ingredients
                </MudText>
            }
        </div>
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public Recipe Recipe { get; set; } = default!;

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public bool IsFavorite { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    [Parameter]
    public string? SharedFromHouseholdName { get; set; }

    [Parameter]
    public EventCallback<Recipe> OnClick { get; set; }

    [Parameter]
    public EventCallback<Recipe> OnToggleFavorite { get; set; }

    private string CardClass => IsSelected 
        ? "recipe-card recipe-card-selected" 
        : "recipe-card";

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Recipe);
    }

    private async Task HandleFavoriteClick()
    {
        await OnToggleFavorite.InvokeAsync(Recipe);
    }

    private string GetIngredientPreview()
    {
        var ingredients = Recipe.Ingredients
            .OrderBy(i => i.SortOrder)
            .Take(3)
            .Select(i => i.Name);

        var preview = string.Join(", ", ingredients);
        var remaining = Recipe.Ingredients.Count - 3;

        if (remaining > 0)
        {
            preview += $", +{remaining} more";
        }

        return preview;
    }

    private static string GetTypeLabel(RecipeType type) => type switch
    {
        RecipeType.Side => "Side",
        RecipeType.Appetizer => "Appetizer",
        RecipeType.Dessert => "Dessert",
        RecipeType.Beverage => "Beverage",
        RecipeType.Sauce => "Sauce",
        RecipeType.Breakfast => "Breakfast",
        RecipeType.Snack => "Snack",
        RecipeType.Other => "Other",
        _ => type.ToString()
    };

    private static Color GetTypeColor(RecipeType type) => type switch
    {
        RecipeType.Dessert => Color.Secondary,
        RecipeType.Beverage => Color.Info,
        RecipeType.Breakfast => Color.Warning,
        RecipeType.Appetizer => Color.Tertiary,
        _ => Color.Default
    };
}

<style>
    .recipe-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .recipe-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .recipe-card-selected {
        outline: 2px solid var(--mud-palette-primary);
        outline-offset: 2px;
    }

    .recipe-image-container {
        position: relative;
        flex-shrink: 0;
    }

    .favorite-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(4px);
    }

    .favorite-button:hover {
        background-color: rgba(255, 255, 255, 1) !important;
    }

    .card-content {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 120px;
    }

    .recipe-title-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
        min-height: 48px;
    }

    .recipe-title {
        flex: 1;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .recipe-badges {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
    }

    .recipe-author {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .recipe-attribution {
        margin-bottom: 4px;
    }

    .recipe-ingredients {
        margin-top: auto;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

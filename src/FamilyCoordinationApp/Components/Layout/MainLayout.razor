@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Shared
@using FamilyCoordinationApp.Data
@using Microsoft.EntityFrameworkCore
@inherits LayoutComponentBase
@implements IDisposable

@inject PresenceService PresenceService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex align-center gap-4">
                        <OnlineUsers CurrentUserId="@_currentUserId" />
                        <SyncStatus />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@context.User.Identity?.Name</MudText>
                        <MudLink Href="/account/logout" Typo="Typo.body2">Sign out</MudLink>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private int _currentUserId;
    private string? _currentUserPicture;
    private string _currentUserInitials = string.Empty;
    private string _currentUserName = string.Empty;
    private System.Timers.Timer? _heartbeatTimer;
    private bool _isDarkMode = true;

    private MudTheme _theme = new()
    {
        PaletteDark = new PaletteDark()
        {
            Black = "#27272f",
            Background = "#1e1e2d",
            BackgroundGray = "#27272f",
            Surface = "#2d2d3d",
            DrawerBackground = "#1e1e2d",
            DrawerText = "rgba(255,255,255, 0.80)",
            DrawerIcon = "rgba(255,255,255, 0.80)",
            AppbarBackground = "#1e1e2d",
            AppbarText = "rgba(255,255,255, 0.80)",
            TextPrimary = "rgba(255,255,255, 0.80)",
            TextSecondary = "rgba(255,255,255, 0.60)",
            ActionDefault = "#adadb1",
            ActionDisabled = "rgba(255,255,255, 0.26)",
            ActionDisabledBackground = "rgba(255,255,255, 0.12)",
            Divider = "rgba(255,255,255, 0.12)",
            DividerLight = "rgba(255,255,255, 0.06)",
            Primary = "#7c4dff",
            PrimaryContrastText = "#ffffff",
            Secondary = "#9c27b0",
            Info = "#2196f3",
            Success = "#00c853",
            Warning = "#ff9800",
            Error = "#f44336"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        StartHeartbeat();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        if (email != null)
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
            if (user != null)
            {
                _currentUserId = user.Id;
                _currentUserPicture = user.PictureUrl;
                _currentUserInitials = user.Initials;
                _currentUserName = user.DisplayName;
                SendHeartbeat();
            }
        }
    }

    private void StartHeartbeat()
    {
        // Send heartbeat every 30 seconds
        _heartbeatTimer = new System.Timers.Timer(30000);
        _heartbeatTimer.Elapsed += (_, _) => SendHeartbeat();
        _heartbeatTimer.AutoReset = true;
        _heartbeatTimer.Start();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        SendHeartbeat();
    }

    private void SendHeartbeat()
    {
        if (_currentUserId > 0)
        {
            var currentPage = new Uri(NavigationManager.Uri).AbsolutePath;
            PresenceService.Heartbeat(_currentUserId, _currentUserName, _currentUserPicture, _currentUserInitials, currentPage);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        _heartbeatTimer?.Stop();
        _heartbeatTimer?.Dispose();
        if (_currentUserId > 0)
        {
            PresenceService.UserDisconnected(_currentUserId);
        }
    }
}

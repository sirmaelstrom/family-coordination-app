---
phase: 06-recipe-import
plan: 04
type: execute
wave: 3
depends_on: [06-03]
files_modified:
  - src/FamilyCoordinationApp/Components/Recipe/ImportRecipeDialog.razor
  - src/FamilyCoordinationApp/Components/Pages/Recipes.razor
autonomous: true

must_haves:
  truths:
    - "User can open import dialog from Recipes page"
    - "User can paste URL and see import progress"
    - "Import errors show clear message with option to proceed to manual entry"
    - "Successful import navigates to recipe edit page"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Recipe/ImportRecipeDialog.razor"
      provides: "MudDialog for URL input and import progress"
      contains: "MudDialog"
    - path: "src/FamilyCoordinationApp/Components/Pages/Recipes.razor"
      provides: "Import button that opens ImportRecipeDialog"
      contains: "ImportRecipeDialog"
  key_links:
    - from: "ImportRecipeDialog"
      to: "IRecipeImportService"
      via: "dependency injection"
      pattern: "IRecipeImportService"
    - from: "Recipes.razor"
      to: "ImportRecipeDialog"
      via: "MudDialog.Show"
      pattern: "ImportRecipeDialog"
---

<objective>
Create recipe import UI: dialog for URL entry with import progress and error handling, integrated with Recipes page.

Purpose: Enable users to import recipes from URLs with clear feedback on progress and errors.
Output: ImportRecipeDialog component and Recipes page integration.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-recipe-import/06-03-SUMMARY.md
@src/FamilyCoordinationApp/Components/Pages/Recipes.razor
@src/FamilyCoordinationApp/Components/Pages/RecipeEdit.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ImportRecipeDialog component</name>
  <files>src/FamilyCoordinationApp/Components/Recipe/ImportRecipeDialog.razor</files>
  <action>
Create ImportRecipeDialog.razor in Components/Recipe folder:

```razor
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Data
@using FamilyCoordinationApp.Data.Entities
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@inject IRecipeImportService ImportService
@inject IRecipeService RecipeService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-4">
            Paste a recipe URL to import. Works best with AllRecipes, Food Network, NYT Cooking, and other popular recipe sites.
        </MudText>

        <MudTextField @bind-Value="_url"
                      Label="Recipe URL"
                      Placeholder="https://www.allrecipes.com/recipe/..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Link"
                      Disabled="_importing"
                      FullWidth="true"
                      Class="mb-4" />

        @if (_importing)
        {
            <div class="d-flex align-center gap-3 mb-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                <MudText>Importing recipe...</MudText>
            </div>
        }

        @if (_error != null)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <MudText>@_error</MudText>
                @if (_showManualOption)
                {
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               OnClick="ProceedToManualEntry"
                               Class="mt-2">
                        Add Recipe Manually
                    </MudButton>
                }
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="_importing">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="ImportRecipe"
                   Disabled="_importing || string.IsNullOrWhiteSpace(_url)">
            @if (_importing)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
            }
            Import
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private string? _url;
    private bool _importing;
    private string? _error;
    private bool _showManualOption;
    private PartialRecipeData? _partialData;

    private void Cancel() => MudDialog.Cancel();

    private async Task ImportRecipe()
    {
        if (string.IsNullOrWhiteSpace(_url))
            return;

        _importing = true;
        _error = null;
        _showManualOption = false;
        StateHasChanged();

        try
        {
            var authState = await AuthStateTask;
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            var userId = userIdClaim != null ? int.Parse(userIdClaim.Value) : 0;

            await using var context = await DbFactory.CreateDbContextAsync();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Id == userId);
            if (user == null)
            {
                _error = "Could not determine current user.";
                return;
            }

            var result = await ImportService.ImportFromUrlAsync(_url, user.HouseholdId, userId);

            if (result.Success && result.Recipe != null)
            {
                // Save the recipe
                var savedRecipe = await RecipeService.CreateRecipeAsync(result.Recipe);

                Snackbar.Add($"Imported \"{savedRecipe.Name}\"", Severity.Success);
                MudDialog.Close(DialogResult.Ok(savedRecipe.RecipeId));

                // Navigate to edit page to review/adjust
                Navigation.NavigateTo($"/recipes/edit/{savedRecipe.RecipeId}");
            }
            else
            {
                _error = result.ErrorMessage ?? "Import failed for unknown reason.";
                _partialData = result.PartialData;
                _showManualOption = result.ErrorType != RecipeImportErrorType.InvalidUrl;
            }
        }
        catch (Exception ex)
        {
            _error = $"An error occurred: {ex.Message}";
            _showManualOption = true;
        }
        finally
        {
            _importing = false;
            StateHasChanged();
        }
    }

    private void ProceedToManualEntry()
    {
        MudDialog.Close(DialogResult.Cancel());

        // Navigate to new recipe page
        // Future enhancement: pass partial data via query string or state
        Navigation.NavigateTo("/recipes/new");
    }
}
```

Key features:
- URL input with link icon
- Loading state with spinner during import
- Error messages with option to proceed to manual entry
- Successful import saves recipe and navigates to edit page
- User can review/adjust imported recipe before finalizing
  </action>
  <verify>File compiles, `dotnet build` passes</verify>
  <done>ImportRecipeDialog component exists with URL input, progress, and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add import button to Recipes page</name>
  <files>src/FamilyCoordinationApp/Components/Pages/Recipes.razor</files>
  <action>
Update Recipes.razor to add an import button that opens ImportRecipeDialog.

1. Add using statement at top (if not present):
```razor
@using FamilyCoordinationApp.Components.Recipe
```

2. Find the existing header area with "New Recipe" button and add an Import button next to it:
```razor
<MudButton Variant="Variant.Outlined"
           Color="Color.Secondary"
           StartIcon="@Icons.Material.Filled.CloudDownload"
           OnClick="OpenImportDialog"
           Class="ml-2">
    Import from URL
</MudButton>
```

3. Add inject for IDialogService (if not present):
```razor
@inject IDialogService DialogService
```

4. Add the OpenImportDialog method in the @code section:
```csharp
private async Task OpenImportDialog()
{
    var options = new DialogOptions
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseButton = true
    };

    var dialog = await DialogService.ShowAsync<ImportRecipeDialog>("Import Recipe", options);
    var result = await dialog.Result;

    if (!result.Canceled)
    {
        // Refresh recipe list after successful import
        await LoadRecipes();
    }
}
```

Note: Ensure LoadRecipes() method exists (likely already present) to refresh the recipe list after import.
  </action>
  <verify>File compiles, `dotnet build` passes, Import button visible in Recipes page header</verify>
  <done>Recipes page has Import from URL button that opens ImportRecipeDialog</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. Test file exists: src/FamilyCoordinationApp/Components/Recipe/ImportRecipeDialog.razor
3. grep -q "ImportRecipeDialog" src/FamilyCoordinationApp/Components/Pages/Recipes.razor (integration)
4. grep -q "Import from URL" src/FamilyCoordinationApp/Components/Pages/Recipes.razor (button text)
5. grep -q "IRecipeImportService" src/FamilyCoordinationApp/Components/Recipe/ImportRecipeDialog.razor (service usage)
</verification>

<success_criteria>
- ImportRecipeDialog exists with URL input and import button
- Dialog shows loading spinner during import
- Dialog shows error message with manual entry option on failure
- Successful import saves recipe and navigates to edit page
- Import button visible on Recipes page
- Solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06-recipe-import/06-04-SUMMARY.md`
</output>

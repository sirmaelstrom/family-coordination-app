---
phase: 02-recipe-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/FamilyCoordinationApp.csproj
  - src/FamilyCoordinationApp/Program.cs
  - src/FamilyCoordinationApp/Components/App.razor
  - src/FamilyCoordinationApp/Components/_Imports.razor
  - src/FamilyCoordinationApp/Data/Entities/Category.cs
  - src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
  - src/FamilyCoordinationApp/Data/Configurations/CategoryConfiguration.cs
  - src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
  - src/FamilyCoordinationApp/Data/SeedData.cs
autonomous: true

must_haves:
  truths:
    - "MudBlazor components render with dark mode theme"
    - "Category table exists in database with default categories seeded"
    - "SignalR accepts file uploads up to 12 MB"
  artifacts:
    - path: "src/FamilyCoordinationApp/Data/Entities/Category.cs"
      provides: "Category entity with soft delete"
      contains: "IsDeleted"
    - path: "src/FamilyCoordinationApp/Components/App.razor"
      provides: "MudBlazor theme provider"
      contains: "MudThemeProvider"
  key_links:
    - from: "Program.cs"
      to: "MudBlazor services"
      via: "AddMudServices()"
      pattern: "AddMudServices"
    - from: "ApplicationDbContext"
      to: "Categories DbSet"
      via: "DbSet property"
      pattern: "DbSet<Category>"
---

<objective>
Set up MudBlazor UI framework with dark mode theme, create Category entity for ingredient categorization, and configure SignalR for file uploads.

Purpose: Establish UI foundation and data model extensions required for recipe management features.
Output: MudBlazor configured with dark theme, Category entity with migration, SignalR configured for 12 MB uploads.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-recipe-management/02-CONTEXT.md
@.planning/phases/02-recipe-management/02-RESEARCH.md

# Phase 1 established DbContextFactory pattern and entity conventions
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

# Existing files to modify
@src/FamilyCoordinationApp/Program.cs
@src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
@src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MudBlazor packages and configure dark mode theme</name>
  <files>
    src/FamilyCoordinationApp/FamilyCoordinationApp.csproj
    src/FamilyCoordinationApp/Program.cs
    src/FamilyCoordinationApp/Components/App.razor
    src/FamilyCoordinationApp/Components/_Imports.razor
  </files>
  <action>
1. Add NuGet packages:
   - MudBlazor (latest stable)
   - Markdig (for markdown rendering)
   - Fractions (for quantity display)

2. In Program.cs, add MudBlazor services BEFORE `builder.Build()`:
   ```csharp
   builder.Services.AddMudServices();
   ```

3. In _Imports.razor, add:
   ```razor
   @using MudBlazor
   ```

4. In App.razor, add inside the `<head>` section:
   ```html
   <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
   <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
   ```

5. In App.razor, add at the END of `<body>` (after Routes component):
   ```razor
   <script src="_content/MudBlazor/MudBlazor.min.js"></script>
   ```

6. In App.razor, wrap Routes with MudThemeProvider and other required providers:
   ```razor
   <MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_theme" />
   <MudPopoverProvider />
   <MudDialogProvider />
   <MudSnackbarProvider />

   <Routes />
   ```

7. Add code block to App.razor with dark mode theme (soft dark gray, not true black):
   ```csharp
   @code {
       private bool _isDarkMode = true;

       private MudTheme _theme = new()
       {
           PaletteDark = new PaletteDark()
           {
               Black = "#27272f",
               Background = "#1e1e2d",
               BackgroundGray = "#27272f",
               Surface = "#2d2d3d",
               DrawerBackground = "#1e1e2d",
               DrawerText = "rgba(255,255,255, 0.80)",
               DrawerIcon = "rgba(255,255,255, 0.80)",
               AppbarBackground = "#1e1e2d",
               AppbarText = "rgba(255,255,255, 0.80)",
               TextPrimary = "rgba(255,255,255, 0.80)",
               TextSecondary = "rgba(255,255,255, 0.60)",
               ActionDefault = "#adadb1",
               ActionDisabled = "rgba(255,255,255, 0.26)",
               ActionDisabledBackground = "rgba(255,255,255, 0.12)",
               Divider = "rgba(255,255,255, 0.12)",
               DividerLight = "rgba(255,255,255, 0.06)",
               Primary = "#7c4dff",
               PrimaryContrastText = "#ffffff",
               Secondary = "#9c27b0",
               Info = "#2196f3",
               Success = "#00c853",
               Warning = "#ff9800",
               Error = "#f44336"
           }
       };
   }
   ```

Note: Keep existing HeadOutlet, CascadingAuthenticationState wrapper, etc. Only add MudBlazor elements.
  </action>
  <verify>
    Run `dotnet build src/FamilyCoordinationApp` - should compile without errors.
  </verify>
  <done>MudBlazor installed, dark mode theme configured, App.razor has MudThemeProvider</done>
</task>

<task type="auto">
  <name>Task 2: Create Category entity with soft delete and update RecipeIngredient</name>
  <files>
    src/FamilyCoordinationApp/Data/Entities/Category.cs
    src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
    src/FamilyCoordinationApp/Data/Configurations/CategoryConfiguration.cs
    src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
  </files>
  <action>
1. Create Category.cs entity:
   ```csharp
   namespace FamilyCoordinationApp.Data.Entities;

   public class Category
   {
       public int HouseholdId { get; set; }
       public int CategoryId { get; set; }
       public string Name { get; set; } = string.Empty;
       public string IconEmoji { get; set; } = string.Empty;  // e.g., "meat", "produce"
       public string Color { get; set; } = "#808080";  // Hex color
       public int SortOrder { get; set; }
       public bool IsDefault { get; set; }  // True for system defaults
       public bool IsDeleted { get; set; }
       public DateTime? DeletedAt { get; set; }

       // Navigation
       public Household Household { get; set; } = default!;
   }
   ```

2. Update RecipeIngredient.cs - add Notes field and GroupName:
   - Add `public string? Notes { get; set; }` after Category
   - Add `public string? GroupName { get; set; }` after Notes (for ingredient sections like "For the sauce")
   - Keep existing Category as string (references Category.Name)

3. Create CategoryConfiguration.cs:
   ```csharp
   using Microsoft.EntityFrameworkCore;
   using Microsoft.EntityFrameworkCore.Metadata.Builders;
   using FamilyCoordinationApp.Data.Entities;

   namespace FamilyCoordinationApp.Data.Configurations;

   public class CategoryConfiguration : IEntityTypeConfiguration<Category>
   {
       public void Configure(EntityTypeBuilder<Category> builder)
       {
           builder.HasKey(c => new { c.HouseholdId, c.CategoryId });

           builder.Property(c => c.Name)
               .IsRequired()
               .HasMaxLength(50);

           builder.Property(c => c.IconEmoji)
               .HasMaxLength(10);

           builder.Property(c => c.Color)
               .HasMaxLength(7);  // #FFFFFF format

           builder.HasQueryFilter(c => !c.IsDeleted);

           builder.HasOne(c => c.Household)
               .WithMany()
               .HasForeignKey(c => c.HouseholdId)
               .OnDelete(DeleteBehavior.Cascade);

           builder.HasIndex(c => new { c.HouseholdId, c.Name })
               .IsUnique()
               .HasFilter("\"IsDeleted\" = false");
       }
   }
   ```

4. Add DbSet to ApplicationDbContext:
   ```csharp
   public DbSet<Category> Categories => Set<Category>();
   ```
  </action>
  <verify>
    Run `dotnet build src/FamilyCoordinationApp` - should compile without errors.
  </verify>
  <done>Category entity created with soft delete, RecipeIngredient has Notes and GroupName fields</done>
</task>

<task type="auto">
  <name>Task 3: Configure SignalR for file uploads and seed default categories</name>
  <files>
    src/FamilyCoordinationApp/Program.cs
    src/FamilyCoordinationApp/Data/SeedData.cs
  </files>
  <action>
1. In Program.cs, configure SignalR message size for file uploads. Find the existing `AddRazorComponents()` call and modify to:
   ```csharp
   builder.Services.AddRazorComponents()
       .AddInteractiveServerComponents()
       .AddHubOptions(options =>
       {
           options.MaximumReceiveMessageSize = 12 * 1024 * 1024; // 12 MB for file uploads
       });
   ```

   Note: The `.AddHubOptions()` chains off `AddInteractiveServerComponents()`.

2. Update SeedData.cs to add default categories. Add a new method:
   ```csharp
   public static async Task SeedDefaultCategoriesAsync(IDbContextFactory<ApplicationDbContext> dbFactory, int householdId)
   {
       await using var context = dbFactory.CreateDbContext();

       // Check if categories already exist for this household
       var existingCount = await context.Categories
           .IgnoreQueryFilters()  // Include soft-deleted
           .CountAsync(c => c.HouseholdId == householdId);

       if (existingCount > 0) return;

       var defaultCategories = new[]
       {
           new Category { HouseholdId = householdId, CategoryId = 1, Name = "Meat", IconEmoji = "meat_on_bone", Color = "#b71c1c", SortOrder = 1, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 2, Name = "Produce", IconEmoji = "leafy_green", Color = "#2e7d32", SortOrder = 2, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 3, Name = "Dairy", IconEmoji = "cheese_wedge", Color = "#ffc107", SortOrder = 3, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 4, Name = "Pantry", IconEmoji = "canned_food", Color = "#795548", SortOrder = 4, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 5, Name = "Spices", IconEmoji = "hot_pepper", Color = "#ff5722", SortOrder = 5, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 6, Name = "Frozen", IconEmoji = "snowflake", Color = "#03a9f4", SortOrder = 6, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 7, Name = "Bakery", IconEmoji = "bread", Color = "#8d6e63", SortOrder = 7, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 8, Name = "Beverages", IconEmoji = "cup_with_straw", Color = "#9c27b0", SortOrder = 8, IsDefault = true },
           new Category { HouseholdId = householdId, CategoryId = 9, Name = "Other", IconEmoji = "package", Color = "#607d8b", SortOrder = 9, IsDefault = true }
       };

       context.Categories.AddRange(defaultCategories);
       await context.SaveChangesAsync();
   }
   ```

3. Call SeedDefaultCategoriesAsync from SeedDevelopmentDataAsync after household is created. Look for where household is created/retrieved and add:
   ```csharp
   await SeedDefaultCategoriesAsync(dbFactory, household.HouseholdId);
   ```

4. Generate EF Core migration:
   ```bash
   cd src/FamilyCoordinationApp
   dotnet ef migrations add AddCategoryEntity
   ```
  </action>
  <verify>
    1. Run `dotnet build src/FamilyCoordinationApp` - compiles
    2. Migration file exists in Migrations/ folder
    3. Run `docker compose up -d` (if not running) and `dotnet ef database update` to apply migration
  </verify>
  <done>SignalR configured for 12 MB uploads, Category entity migration created, default categories seed method added</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` compiles without errors
2. MudBlazor CSS and JS references in App.razor
3. MudThemeProvider configured with dark mode
4. Category entity and configuration exist
5. Migration for Category entity generated
6. SeedDefaultCategoriesAsync method exists in SeedData.cs
</verification>

<success_criteria>
- MudBlazor packages installed and services registered
- Dark mode theme with soft gray background configured
- Category entity with composite key (HouseholdId, CategoryId) created
- Global query filter for soft delete on Category
- RecipeIngredient has Notes and GroupName fields
- SignalR MaximumReceiveMessageSize set to 12 MB
- Default categories seed method created
- EF Core migration generated
</success_criteria>

<output>
After completion, create `.planning/phases/02-recipe-management/02-01-SUMMARY.md`
</output>

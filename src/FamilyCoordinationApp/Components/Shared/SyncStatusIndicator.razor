@using FamilyCoordinationApp.Services
@implements IDisposable

@inject PollingService PollingService

<MudTooltip Text="@StatusText" Placement="Placement.Bottom">
    <div class="sync-status @StatusClass">
        @if (PollingService.Status == SyncStatus.Syncing)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" Style="width: 16px; height: 16px;" />
        }
        else
        {
            <MudIcon Icon="@StatusIcon" Size="Size.Small" Color="@StatusColor" />
        }
    </div>
</MudTooltip>

@code {
    private string StatusText => PollingService.Status switch
    {
        SyncStatus.Synced => $"Synced {GetTimeSinceLastSync()}",
        SyncStatus.Syncing => "Syncing...",
        SyncStatus.Offline => "Offline - changes may not sync",
        SyncStatus.Error => $"Sync error (retry {PollingService.ConsecutiveErrors})",
        _ => "Unknown status"
    };

    private string StatusClass => PollingService.Status switch
    {
        SyncStatus.Synced => "sync-ok",
        SyncStatus.Syncing => "sync-active",
        SyncStatus.Offline => "sync-offline",
        SyncStatus.Error => "sync-error",
        _ => ""
    };

    private string StatusIcon => PollingService.Status switch
    {
        SyncStatus.Synced => Icons.Material.Filled.CloudDone,
        SyncStatus.Syncing => Icons.Material.Filled.CloudSync,
        SyncStatus.Offline => Icons.Material.Filled.CloudOff,
        SyncStatus.Error => Icons.Material.Filled.ErrorOutline,
        _ => Icons.Material.Filled.Cloud
    };

    private Color StatusColor => PollingService.Status switch
    {
        SyncStatus.Synced => Color.Success,
        SyncStatus.Syncing => Color.Primary,
        SyncStatus.Offline => Color.Warning,
        SyncStatus.Error => Color.Error,
        _ => Color.Default
    };

    protected override void OnInitialized()
    {
        PollingService.OnStatusChanged += OnStatusChanged;
    }

    private void OnStatusChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetTimeSinceLastSync()
    {
        if (PollingService.LastSyncTime == null)
            return "never";

        var elapsed = DateTime.UtcNow - PollingService.LastSyncTime.Value;
        return elapsed.TotalSeconds < 10 ? "just now"
            : elapsed.TotalMinutes < 1 ? $"{(int)elapsed.TotalSeconds}s ago"
            : elapsed.TotalMinutes < 60 ? $"{(int)elapsed.TotalMinutes}m ago"
            : "a while ago";
    }

    public void Dispose()
    {
        PollingService.OnStatusChanged -= OnStatusChanged;
    }
}

<style>
    .sync-status {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        min-width: 24px;
        min-height: 24px;
    }

    .sync-ok {
        color: var(--mud-palette-success);
    }

    .sync-active {
        color: var(--mud-palette-primary);
    }

    .sync-offline {
        color: var(--mud-palette-warning);
    }

    .sync-error {
        color: var(--mud-palette-error);
    }
</style>

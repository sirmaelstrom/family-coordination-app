@page "/meal-plan"
@using FamilyCoordinationApp.Data
@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.MealPlan
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@attribute [Authorize]
@implements IDisposable

@inject IMealPlanService MealPlanService
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject DataNotifier Notifier

<PageTitle>Meal Plan - Family Kitchen</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-4">Meal Plan</MudText>

    <!-- IMPORTANT: Use explicit event handler, NOT @bind-WeekStartDate -->
    <!-- @bind uses WeekStartDateChanged internally but doesn't trigger our reload logic -->
    <MealPlanNavigation WeekStartDate="@_weekStartDate"
                        WeekStartDateChanged="@HandleWeekChanged" />

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="my-4" />
    }
    else
    {
        <!-- Desktop: Calendar Grid (md and up) -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <WeeklyCalendarView WeekStartDate="@_weekStartDate"
                                Entries="@_entries"
                                OnSlotClick="HandleSlotClick"
                                OnRemoveEntry="HandleRemoveEntry"
                                OnViewRecipe="HandleViewRecipe"
                                OnViewCustomMeal="HandleViewCustomMeal" />
        </MudHidden>

        <!-- Mobile: List View (sm and down) -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <WeeklyListView WeekStartDate="@_weekStartDate"
                            Entries="@_entries"
                            OnSlotClick="HandleSlotClick"
                            OnRemoveEntry="HandleRemoveEntry"
                            OnViewRecipe="HandleViewRecipe"
                            OnViewCustomMeal="HandleViewCustomMeal" />
        </MudHidden>
    }
</MudContainer>

@code {
    private DateOnly _weekStartDate;
    private List<MealPlanEntry> _entries = new();
    private bool _loading = true;
    private int _householdId;
    private int _userId;

    protected override async Task OnInitializedAsync()
    {
        Notifier.OnMealPlanChanged += OnDataChanged;

        // Get current week's Monday
        var today = DateOnly.FromDateTime(DateTime.Today);
        _weekStartDate = MealPlanService.GetWeekStartDate(today);

        // Get user context
        await LoadUserContextAsync();

        await LoadMealPlanAsync();
    }

    private async Task LoadUserContextAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        await using var context = await DbFactory.CreateDbContextAsync();
        var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
        if (user == null)
        {
            throw new InvalidOperationException("User not found. Please log in again.");
        }
        _householdId = user.HouseholdId;
        _userId = user.Id;
    }

    private void OnDataChanged(int householdId)
    {
        // Security: Only respond to changes for our household
        if (householdId != _householdId)
            return;
            
        InvokeAsync(async () =>
        {
            await LoadMealPlanAsync();
            StateHasChanged();
        });
    }

    private async Task LoadMealPlanAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var mealPlan = await MealPlanService.GetOrCreateMealPlanAsync(_householdId, _weekStartDate);
            _entries = mealPlan.Entries.ToList();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    // CRITICAL: This handler updates the week AND reloads data
    // Called explicitly via WeekStartDateChanged="@HandleWeekChanged"
    private async Task HandleWeekChanged(DateOnly newWeekStart)
    {
        _weekStartDate = newWeekStart;
        await LoadMealPlanAsync();
    }

    private async Task HandleSlotClick((DateOnly Date, MealType MealType) slot)
    {
        var parameters = new DialogParameters<RecipePickerDialog>
        {
            { x => x.HouseholdId, _householdId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<RecipePickerDialog>("Select Meal", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is RecipePickerDialog.MealSelection selection)
        {
            await MealPlanService.AddMealAsync(
                _householdId,
                slot.Date,
                slot.MealType,
                selection.RecipeId,
                selection.CustomMealName,
                selection.Notes,
                _userId);

            await LoadMealPlanAsync();
        }
    }

    private async Task HandleRemoveEntry(MealPlanEntry entry)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove Meal",
            $"Remove this meal from {entry.Date:MMM d}?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await MealPlanService.RemoveMealAsync(_householdId, entry.MealPlanId, entry.EntryId);
            await LoadMealPlanAsync();
        }
    }

    private async Task HandleViewRecipe(Recipe recipe)
    {
        var parameters = new DialogParameters<RecipeDetailDialog>
        {
            { x => x.Recipe, recipe }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<RecipeDetailDialog>(recipe.Name, parameters, options);
    }

    private async Task HandleViewCustomMeal(MealPlanEntry entry)
    {
        var content = new List<string> { $"**{entry.CustomMealName}**" };
        
        if (!string.IsNullOrWhiteSpace(entry.Notes))
        {
            content.Add($"\nüìù Notes:\n{entry.Notes}");
        }

        content.Add($"\nüìÖ {entry.Date:dddd, MMMM d}");
        content.Add($"üçΩÔ∏è {entry.MealType}");

        await DialogService.ShowMessageBox(
            "Custom Meal",
            (MarkupString)string.Join("\n", content).Replace("\n", "<br/>"),
            yesText: "Close");
    }

    public void Dispose()
    {
        Notifier.OnMealPlanChanged -= OnDataChanged;
    }
}

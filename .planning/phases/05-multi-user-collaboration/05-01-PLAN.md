---
phase: 05-multi-user-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/Data/Entities/User.cs
  - src/FamilyCoordinationApp/Data/Entities/Recipe.cs
  - src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
  - src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
  - src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
  - src/FamilyCoordinationApp/Data/Migrations/*.cs
autonomous: true

must_haves:
  truths:
    - "User entity has PictureUrl and Initials properties for avatar display"
    - "Entities with concurrent access have Version property mapped to PostgreSQL xmin"
    - "Entities track UpdatedAt and UpdatedByUserId for change detection"
  artifacts:
    - path: "src/FamilyCoordinationApp/Data/Entities/User.cs"
      provides: "PictureUrl and Initials properties"
      contains: "PictureUrl"
    - path: "src/FamilyCoordinationApp/Data/Entities/Recipe.cs"
      provides: "Version concurrency token and UpdatedByUserId"
      contains: "[Timestamp]"
    - path: "src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs"
      provides: "Version concurrency token and UpdatedByUserId"
      contains: "[Timestamp]"
  key_links:
    - from: "Entity Version property"
      to: "PostgreSQL xmin system column"
      via: "[Timestamp] attribute"
      pattern: "IsRowVersion|\\[Timestamp\\]"
---

<objective>
Add multi-user collaboration schema fields: concurrency tokens (PostgreSQL xmin), user profile picture support, and change tracking fields.

Purpose: Enable optimistic concurrency detection and user attribution display throughout the app.
Output: Updated entity classes with migration applied.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-user-collaboration/05-RESEARCH.md
@src/FamilyCoordinationApp/Data/Entities/User.cs
@src/FamilyCoordinationApp/Data/Entities/Recipe.cs
@src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
@src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile fields to User entity</name>
  <files>src/FamilyCoordinationApp/Data/Entities/User.cs</files>
  <action>
Add two new properties to User entity for avatar display:
- `public string? PictureUrl { get; set; }` - Google OAuth profile picture URL (nullable for users without picture)
- `public string Initials { get; set; } = string.Empty;` - Computed initials for fallback display (e.g., "John Smith" -> "JS")

The Initials field will be computed and stored when user is created/updated (not a computed column).
  </action>
  <verify>File compiles without errors, new properties exist on User class</verify>
  <done>User entity has PictureUrl and Initials properties</done>
</task>

<task type="auto">
  <name>Task 2: Add concurrency tokens and tracking fields to entities</name>
  <files>
    src/FamilyCoordinationApp/Data/Entities/Recipe.cs
    src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
    src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
  </files>
  <action>
Add to Recipe, ShoppingListItem, and MealPlanEntry entities:

1. Concurrency token (maps to PostgreSQL xmin):
```csharp
[Timestamp]
public uint Version { get; set; }
```

2. Change tracking fields (for polling change detection):
- Recipe: already has UpdatedAt - add `public int? UpdatedByUserId { get; set; }` and navigation `public User? UpdatedBy { get; set; }`
- ShoppingListItem: add `public DateTime? UpdatedAt { get; set; }` and `public int? UpdatedByUserId { get; set; }` and navigation `public User? UpdatedBy { get; set; }`
- MealPlanEntry: add `public DateTime? UpdatedAt { get; set; }` and `public int? UpdatedByUserId { get; set; }` and navigation `public User? UpdatedBy { get; set; }`

Note: Use `using System.ComponentModel.DataAnnotations;` for [Timestamp] attribute.
  </action>
  <verify>Files compile without errors, [Timestamp] attribute present on Version properties</verify>
  <done>Entities have Version concurrency token and change tracking fields</done>
</task>

<task type="auto">
  <name>Task 3: Configure entity mappings and create migration</name>
  <files>
    src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
    src/FamilyCoordinationApp/Data/Migrations/*.cs
  </files>
  <action>
1. In ApplicationDbContext.OnModelCreating, add configuration for the Version property to use xmin:
```csharp
// Configure xmin concurrency token for collaborative entities
modelBuilder.Entity<Recipe>()
    .Property(e => e.Version)
    .IsRowVersion();

modelBuilder.Entity<ShoppingListItem>()
    .Property(e => e.Version)
    .IsRowVersion();

modelBuilder.Entity<MealPlanEntry>()
    .Property(e => e.Version)
    .IsRowVersion();
```

Note: The [Timestamp] attribute on uint property in Npgsql automatically maps to xmin. The fluent API call is optional but explicit.

2. Configure foreign key relationships for UpdatedByUserId (optional, allows null):
```csharp
modelBuilder.Entity<Recipe>()
    .HasOne(r => r.UpdatedBy)
    .WithMany()
    .HasForeignKey(r => r.UpdatedByUserId)
    .OnDelete(DeleteBehavior.SetNull);
```
(Similar for ShoppingListItem and MealPlanEntry)

3. Run migration:
```bash
cd src/FamilyCoordinationApp
dotnet ef migrations add AddCollaborationFields
```
  </action>
  <verify>Migration created successfully, `dotnet build` passes</verify>
  <done>DbContext configured with xmin mapping, migration created</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. Migration file exists in Data/Migrations with AddCollaborationFields name
3. Grep for [Timestamp] shows Recipe, ShoppingListItem, MealPlanEntry all have Version property
4. User.cs contains PictureUrl and Initials properties
</verification>

<success_criteria>
- User entity has PictureUrl (string?) and Initials (string) properties
- Recipe, ShoppingListItem, MealPlanEntry have Version (uint) with [Timestamp] attribute
- Recipe, ShoppingListItem, MealPlanEntry have UpdatedAt and UpdatedByUserId
- Migration created and solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-user-collaboration/05-01-SUMMARY.md`
</output>

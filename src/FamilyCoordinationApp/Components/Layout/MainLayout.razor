@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Shared
@using FamilyCoordinationApp.Data
@using Microsoft.EntityFrameworkCore
@inherits LayoutComponentBase
@implements IDisposable

@inject PresenceService PresenceService
@inject PollingService PollingService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject ISiteAdminService SiteAdminService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <!-- Collapsible Drawer - simple click toggle -->
    <MudDrawer @bind-Open="_drawerOpen" 
               ClipMode="DrawerClipMode.Always" 
               Elevation="2"
               Variant="@DrawerVariant.Mini"
               OpenMiniOnHover="false">
        <NavMenu IsExpanded="_drawerOpen" />
    </MudDrawer>

    <!-- App Bar -->
    <MudAppBar Elevation="1" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                       Color="Color.Inherit" 
                       Edge="Edge.Start" 
                       OnClick="@ToggleDrawer"
                       Title="Toggle menu" />
        
        <MudText Typo="Typo.h6" Class="ml-2">Family Kitchen</MudText>
        
        <MudSpacer />
        
        <AuthorizeView>
            <Authorized>
                <div class="d-flex align-center gap-2 gap-md-4">
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <OnlineUsers CurrentUserId="@_currentUserId" />
                    </MudHidden>
                    <SyncStatusIndicator />
                    <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                   Color="Color.Inherit"
                                   OnClick="ToggleDarkMode"
                                   Title="@(_isDarkMode ? "Switch to light mode" : "Switch to dark mode")" />
                    @if (_isSiteAdmin)
                    {
                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined" Class="px-2">
                                <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Small" Class="mr-1" />
                                Admin
                            </MudChip>
                        </MudHidden>
                    }
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <MudText Typo="Typo.body2">@context.User.Identity?.Name</MudText>
                    </MudHidden>
                    <MudIconButton Icon="@Icons.Material.Filled.Logout" 
                                   Color="Color.Inherit" 
                                   Href="/account/logout"
                                   Title="Sign out" />
                </div>
            </Authorized>
        </AuthorizeView>
    </MudAppBar>

    <!-- Main Content -->
    <MudMainContent Class="pt-16">
        @* Offline/Error Banner *@
        @if (PollingService.Status == SyncStatus.Offline)
        {
            <MudAlert Severity="Severity.Warning" 
                      Dense="true" 
                      Class="mx-4 mt-2"
                      Icon="@Icons.Material.Filled.WifiOff">
                <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                    <span>You're offline. Changes may not sync until connection is restored.</span>
                </div>
            </MudAlert>
        }
        else if (PollingService.Status == SyncStatus.Error && PollingService.ConsecutiveErrors >= 3)
        {
            <MudAlert Severity="Severity.Error" 
                      Dense="true" 
                      Class="mx-4 mt-2"
                      Icon="@Icons.Material.Filled.ErrorOutline">
                <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                    <span>Sync error â€” please refresh the page</span>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Text" 
                               Color="Color.Inherit"
                               OnClick="RefreshPage">
                        Refresh
                    </MudButton>
                </div>
            </MudAlert>
        }

        <div class="content-wrapper">
            @Body
        </div>
        
        <!-- Footer -->
        <footer class="app-footer px-4 py-3">
            <div class="d-flex justify-center align-center gap-4 flex-wrap">
                <MudLink Href="/privacy" Color="Color.Secondary" Typo="Typo.caption">Privacy Policy</MudLink>
                <MudText Typo="Typo.caption" Color="Color.Secondary">â€¢</MudText>
                <MudLink Href="/terms" Color="Color.Secondary" Typo="Typo.caption">Terms of Service</MudLink>
                <MudText Typo="Typo.caption" Color="Color.Secondary">â€¢</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Â© @DateTime.Now.Year sirmaelstrom</MudText>
            </div>
        </footer>
    </MudMainContent>
</MudLayout>

<!-- Floating feedback button (above page FABs) -->
<MudFab Color="Color.Tertiary"
        StartIcon="@Icons.Material.Filled.Feedback"
        OnClick="OpenFeedbackDialog"
        Style="position: fixed; bottom: 88px; right: 24px; z-index: 1000;"
        Size="Size.Medium"
        aria-label="Send feedback" />

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private int _currentUserId;
    private string? _currentUserPicture;
    private string _currentUserInitials = string.Empty;
    private string _currentUserName = string.Empty;
    private System.Timers.Timer? _heartbeatTimer;
    private bool _isDarkMode = false;
    private bool _isSiteAdmin = false;
    private bool _drawerOpen = true;

    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2E7D32",
            PrimaryContrastText = "#ffffff",
            Secondary = "#FF6F00",
            SecondaryContrastText = "#ffffff",
            Tertiary = "#5C6BC0",
            Background = "#FAFAFA",
            Surface = "#FFFFFF",
            DrawerBackground = "#F5F5F5",
            AppbarBackground = "#2E7D32",
            AppbarText = "#FFFFFF",
            Success = "#43A047",
            Warning = "#FB8C00",
            Error = "#E53935",
            Info = "#1E88E5"
        },
        PaletteDark = new PaletteDark()
        {
            Black = "#1a1a1a",
            Background = "#121212",
            BackgroundGray = "#1e1e1e",
            Surface = "#1e1e1e",
            DrawerBackground = "#1a1a1a",
            DrawerText = "rgba(255,255,255, 0.87)",
            DrawerIcon = "rgba(255,255,255, 0.87)",
            AppbarBackground = "#1a1a1a",
            AppbarText = "rgba(255,255,255, 0.87)",
            TextPrimary = "rgba(255,255,255, 0.87)",
            TextSecondary = "rgba(255,255,255, 0.60)",
            ActionDefault = "#adadb1",
            ActionDisabled = "rgba(255,255,255, 0.26)",
            ActionDisabledBackground = "rgba(255,255,255, 0.12)",
            Divider = "rgba(255,255,255, 0.12)",
            DividerLight = "rgba(255,255,255, 0.06)",
            Primary = "#66BB6A",
            PrimaryContrastText = "#000000",
            Secondary = "#FFB74D",
            SecondaryContrastText = "#000000",
            Tertiary = "#7986CB",
            Info = "#42A5F5",
            Success = "#66BB6A",
            Warning = "#FFA726",
            Error = "#EF5350"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        StartHeartbeat();
        NavigationManager.LocationChanged += OnLocationChanged;
        PollingService.OnStatusChanged += OnSyncStatusChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var darkMode = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "darkMode");
                if (!string.IsNullOrEmpty(darkMode) && bool.TryParse(darkMode, out var isDark))
                {
                    _isDarkMode = isDark;
                }
                
                var drawerOpen = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "drawerOpen");
                if (!string.IsNullOrEmpty(drawerOpen) && bool.TryParse(drawerOpen, out var isOpen))
                {
                    _drawerOpen = isOpen;
                }
                
                StateHasChanged();
            }
            catch
            {
                // localStorage not available
            }
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
        _ = SaveDrawerState();
    }

    private async Task SaveDrawerState()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "drawerOpen", _drawerOpen.ToString().ToLower());
        }
        catch { }
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "darkMode", _isDarkMode.ToString().ToLower());
        }
        catch { }
    }

    private void OnSyncStatusChanged() => InvokeAsync(StateHasChanged);

    private void RefreshPage() => NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        if (email != null)
        {
            _isSiteAdmin = SiteAdminService.IsSiteAdmin(email);

            await using var context = await DbFactory.CreateDbContextAsync();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
            if (user != null)
            {
                _currentUserId = user.Id;
                _currentUserPicture = user.PictureUrl;
                _currentUserInitials = user.Initials;
                _currentUserName = user.DisplayName;
                SendHeartbeat();
            }
        }
    }

    private void StartHeartbeat()
    {
        _heartbeatTimer = new System.Timers.Timer(30000);
        _heartbeatTimer.Elapsed += (_, _) => SendHeartbeat();
        _heartbeatTimer.AutoReset = true;
        _heartbeatTimer.Start();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e) => SendHeartbeat();

    private void SendHeartbeat()
    {
        if (_currentUserId > 0)
        {
            var currentPage = new Uri(NavigationManager.Uri).AbsolutePath;
            PresenceService.Heartbeat(_currentUserId, _currentUserName, _currentUserPicture, _currentUserInitials, currentPage);
        }
    }

    private async Task OpenFeedbackDialog()
    {
        var parameters = new DialogParameters<FeedbackDialog>
        {
            { x => x.CurrentPage, NavigationManager.Uri }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<FeedbackDialog>("Send Feedback", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            Snackbar.Add("Thank you for your feedback!", Severity.Success);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        PollingService.OnStatusChanged -= OnSyncStatusChanged;
        _heartbeatTimer?.Stop();
        _heartbeatTimer?.Dispose();
        if (_currentUserId > 0)
        {
            PresenceService.UserDisconnected(_currentUserId);
        }
    }
}

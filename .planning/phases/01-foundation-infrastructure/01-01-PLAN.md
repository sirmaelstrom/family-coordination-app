---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/FamilyCoordinationApp.csproj
  - src/FamilyCoordinationApp/Program.cs
  - src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
  - src/FamilyCoordinationApp/Data/Entities/Household.cs
  - src/FamilyCoordinationApp/Data/Entities/User.cs
  - src/FamilyCoordinationApp/Data/Entities/Recipe.cs
  - src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
  - src/FamilyCoordinationApp/Data/Entities/MealPlan.cs
  - src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
  - src/FamilyCoordinationApp/Data/Entities/ShoppingList.cs
  - src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
  - src/FamilyCoordinationApp/Data/Configurations/HouseholdConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/UserConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/RecipeConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/RecipeIngredientConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/MealPlanConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/MealPlanEntryConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/ShoppingListConfiguration.cs
  - src/FamilyCoordinationApp/Data/Configurations/ShoppingListItemConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "Database schema includes HouseholdId on all tenant-owned entities"
    - "Composite primary keys enforce (HouseholdId, EntityId) pattern"
    - "Composite foreign keys prevent cross-household references"
    - "DbContextFactory pattern is registered for Blazor Server concurrency"
  artifacts:
    - path: "src/FamilyCoordinationApp/FamilyCoordinationApp.csproj"
      provides: "Project file with EF Core PostgreSQL packages"
      contains: "Npgsql.EntityFrameworkCore.PostgreSQL"
    - path: "src/FamilyCoordinationApp/Data/ApplicationDbContext.cs"
      provides: "EF Core DbContext with DbSet properties"
      exports: ["ApplicationDbContext"]
    - path: "src/FamilyCoordinationApp/Data/Entities/Recipe.cs"
      provides: "Recipe entity with composite key"
      contains: "HouseholdId"
    - path: "src/FamilyCoordinationApp/Data/Configurations/RecipeConfiguration.cs"
      provides: "EF Core Fluent API configuration"
      contains: "HasKey"
  key_links:
    - from: "Program.cs"
      to: "ApplicationDbContext"
      via: "AddDbContextFactory registration"
      pattern: "AddDbContextFactory<ApplicationDbContext>"
    - from: "RecipeConfiguration.cs"
      to: "Recipe entity"
      via: "Composite key configuration"
      pattern: "HasKey.*HouseholdId.*RecipeId"
---

<objective>
Create Blazor Server project with complete database schema using composite keys for multi-tenant isolation.

Purpose: Establishes the data foundation that all subsequent phases depend on. The composite key pattern (HouseholdId + EntityId) enforces tenant isolation at the database level, preventing cross-household data leaks.

Output: A compilable Blazor Server project with EF Core entities, Fluent API configurations, and DbContextFactory registration. All entities ready for future phases (Recipes, MealPlans, ShoppingLists).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Blazor Server project with EF Core PostgreSQL packages</name>
  <files>
    src/FamilyCoordinationApp/FamilyCoordinationApp.csproj
    src/FamilyCoordinationApp/Program.cs
  </files>
  <action>
Create new Blazor Server project:
```bash
mkdir -p src
cd src
dotnet new blazor -n FamilyCoordinationApp --interactivity Server
```

Add required NuGet packages:
```bash
cd FamilyCoordinationApp
dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL
dotnet add package Microsoft.EntityFrameworkCore.Design
dotnet add package Bogus
```

In Program.cs, register DbContextFactory BEFORE other services:
```csharp
// Connection string from configuration (will come from environment in Docker)
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? "Host=localhost;Database=familyapp;Username=familyapp;Password=***REDACTED***";

builder.Services.AddDbContextFactory<ApplicationDbContext>(options =>
    options.UseNpgsql(connectionString));
```

Why DbContextFactory: Blazor Server circuits are long-lived; scoped DbContext causes concurrency issues. Factory creates short-lived instances per operation.
  </action>
  <verify>
```bash
cd /home/sirm/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
grep "AddDbContextFactory" Program.cs
```
Build succeeds (warnings OK, errors not OK). DbContextFactory registration present in Program.cs.
  </verify>
  <done>Project compiles with EF Core PostgreSQL packages. DbContextFactory registered in DI container.</done>
</task>

<task type="auto">
  <name>Task 2: Create entity classes with composite key structure</name>
  <files>
    src/FamilyCoordinationApp/Data/Entities/Household.cs
    src/FamilyCoordinationApp/Data/Entities/User.cs
    src/FamilyCoordinationApp/Data/Entities/Recipe.cs
    src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
    src/FamilyCoordinationApp/Data/Entities/MealPlan.cs
    src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
    src/FamilyCoordinationApp/Data/Entities/ShoppingList.cs
    src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
  </files>
  <action>
Create Data/Entities/ directory and entity classes.

**Household.cs** (root entity, simple int PK):
```csharp
public class Household
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }

    // Navigation properties
    public ICollection<User> Users { get; set; } = new List<User>();
    public ICollection<Recipe> Recipes { get; set; } = new List<Recipe>();
    public ICollection<MealPlan> MealPlans { get; set; } = new List<MealPlan>();
    public ICollection<ShoppingList> ShoppingLists { get; set; } = new List<ShoppingList>();
}
```

**User.cs** (references Household, stores Google OAuth info):
```csharp
public class User
{
    public int Id { get; set; }
    public int HouseholdId { get; set; }
    public string Email { get; set; } = string.Empty;
    public string DisplayName { get; set; } = string.Empty;
    public string GoogleId { get; set; } = string.Empty;
    public bool IsWhitelisted { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }

    // Navigation
    public Household Household { get; set; } = default!;
}
```

**Recipe.cs** (composite PK: HouseholdId + RecipeId):
```csharp
public class Recipe
{
    public int HouseholdId { get; set; }
    public int RecipeId { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Instructions { get; set; }
    public string? ImagePath { get; set; }
    public string? SourceUrl { get; set; }
    public int? Servings { get; set; }
    public int? PrepTimeMinutes { get; set; }
    public int? CookTimeMinutes { get; set; }
    public int CreatedByUserId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public bool IsDeleted { get; set; }

    // Navigation
    public Household Household { get; set; } = default!;
    public User CreatedBy { get; set; } = default!;
    public ICollection<RecipeIngredient> Ingredients { get; set; } = new List<RecipeIngredient>();
}
```

**RecipeIngredient.cs** (composite PK: HouseholdId + RecipeId + IngredientId):
```csharp
public class RecipeIngredient
{
    public int HouseholdId { get; set; }
    public int RecipeId { get; set; }
    public int IngredientId { get; set; }
    public string Name { get; set; } = string.Empty;
    public decimal? Quantity { get; set; }
    public string? Unit { get; set; }
    public string Category { get; set; } = "Pantry"; // Meat, Produce, Dairy, Pantry, Spices
    public int SortOrder { get; set; }

    // Navigation
    public Recipe Recipe { get; set; } = default!;
}
```

**MealPlan.cs** (composite PK: HouseholdId + MealPlanId):
```csharp
public class MealPlan
{
    public int HouseholdId { get; set; }
    public int MealPlanId { get; set; }
    public DateOnly WeekStartDate { get; set; }
    public DateTime CreatedAt { get; set; }

    // Navigation
    public Household Household { get; set; } = default!;
    public ICollection<MealPlanEntry> Entries { get; set; } = new List<MealPlanEntry>();
}
```

**MealPlanEntry.cs** (composite PK: HouseholdId + MealPlanId + EntryId):
```csharp
public enum MealType { Breakfast, Lunch, Dinner, Snack }

public class MealPlanEntry
{
    public int HouseholdId { get; set; }
    public int MealPlanId { get; set; }
    public int EntryId { get; set; }
    public DateOnly Date { get; set; }
    public MealType MealType { get; set; }
    public int? RecipeId { get; set; }  // Null for custom meals
    public string? CustomMealName { get; set; }  // "Leftovers", "Eating out"
    public string? Notes { get; set; }

    // Navigation
    public MealPlan MealPlan { get; set; } = default!;
    public Recipe? Recipe { get; set; }
}
```

**ShoppingList.cs** (composite PK: HouseholdId + ShoppingListId):
```csharp
public class ShoppingList
{
    public int HouseholdId { get; set; }
    public int ShoppingListId { get; set; }
    public string Name { get; set; } = string.Empty;
    public int? MealPlanId { get; set; }  // If generated from meal plan
    public DateTime CreatedAt { get; set; }
    public bool IsArchived { get; set; }

    // Navigation
    public Household Household { get; set; } = default!;
    public MealPlan? MealPlan { get; set; }
    public ICollection<ShoppingListItem> Items { get; set; } = new List<ShoppingListItem>();
}
```

**ShoppingListItem.cs** (composite PK: HouseholdId + ShoppingListId + ItemId):
```csharp
public class ShoppingListItem
{
    public int HouseholdId { get; set; }
    public int ShoppingListId { get; set; }
    public int ItemId { get; set; }
    public string Name { get; set; } = string.Empty;
    public decimal? Quantity { get; set; }
    public string? Unit { get; set; }
    public string Category { get; set; } = "Pantry";
    public bool IsChecked { get; set; }
    public int? AddedByUserId { get; set; }
    public DateTime AddedAt { get; set; }
    public DateTime? CheckedAt { get; set; }

    // Navigation
    public ShoppingList ShoppingList { get; set; } = default!;
    public User? AddedBy { get; set; }
}
```

Key design notes:
- HouseholdId is ALWAYS first in composite keys (consistency)
- Navigation properties use `= default!` for non-nullable refs (EF handles initialization)
- Soft delete on Recipe (IsDeleted) per requirements
- Category uses string not enum (Meat, Produce, Dairy, Pantry, Spices) for flexibility
  </action>
  <verify>
```bash
cd /home/sirm/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
```
Build succeeds. All entity files exist in Data/Entities/.
  </verify>
  <done>All 8 entity classes created with proper composite key properties and navigation properties.</done>
</task>

<task type="auto">
  <name>Task 3: Create EF Core Fluent API configurations and DbContext</name>
  <files>
    src/FamilyCoordinationApp/Data/ApplicationDbContext.cs
    src/FamilyCoordinationApp/Data/Configurations/HouseholdConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/UserConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/RecipeConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/RecipeIngredientConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/MealPlanConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/MealPlanEntryConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/ShoppingListConfiguration.cs
    src/FamilyCoordinationApp/Data/Configurations/ShoppingListItemConfiguration.cs
  </files>
  <action>
Create Data/Configurations/ directory with IEntityTypeConfiguration classes.

**ApplicationDbContext.cs**:
```csharp
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options) { }

    public DbSet<Household> Households => Set<Household>();
    public DbSet<User> Users => Set<User>();
    public DbSet<Recipe> Recipes => Set<Recipe>();
    public DbSet<RecipeIngredient> RecipeIngredients => Set<RecipeIngredient>();
    public DbSet<MealPlan> MealPlans => Set<MealPlan>();
    public DbSet<MealPlanEntry> MealPlanEntries => Set<MealPlanEntry>();
    public DbSet<ShoppingList> ShoppingLists => Set<ShoppingList>();
    public DbSet<ShoppingListItem> ShoppingListItems => Set<ShoppingListItem>();

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(ApplicationDbContext).Assembly);
    }
}
```

**RecipeConfiguration.cs** (example of composite FK pattern):
```csharp
public class RecipeConfiguration : IEntityTypeConfiguration<Recipe>
{
    public void Configure(EntityTypeBuilder<Recipe> builder)
    {
        builder.ToTable("Recipes");

        // Composite primary key (HouseholdId first by convention)
        builder.HasKey(r => new { r.HouseholdId, r.RecipeId });

        // Auto-increment RecipeId within household context
        builder.Property(r => r.RecipeId).ValueGeneratedOnAdd();

        // Properties
        builder.Property(r => r.Name).IsRequired().HasMaxLength(200);
        builder.Property(r => r.ImagePath).HasMaxLength(500);
        builder.Property(r => r.SourceUrl).HasMaxLength(2000);
        builder.Property(r => r.Category).HasMaxLength(50);

        // Relationships
        builder.HasOne(r => r.Household)
            .WithMany(h => h.Recipes)
            .HasForeignKey(r => r.HouseholdId)
            .OnDelete(DeleteBehavior.Cascade);

        builder.HasOne(r => r.CreatedBy)
            .WithMany()
            .HasForeignKey(r => r.CreatedByUserId)
            .OnDelete(DeleteBehavior.Restrict);
    }
}
```

**RecipeIngredientConfiguration.cs** (composite FK to composite PK):
```csharp
public class RecipeIngredientConfiguration : IEntityTypeConfiguration<RecipeIngredient>
{
    public void Configure(EntityTypeBuilder<RecipeIngredient> builder)
    {
        builder.ToTable("RecipeIngredients");

        // Composite PK: HouseholdId + RecipeId + IngredientId
        builder.HasKey(ri => new { ri.HouseholdId, ri.RecipeId, ri.IngredientId });
        builder.Property(ri => ri.IngredientId).ValueGeneratedOnAdd();

        builder.Property(ri => ri.Name).IsRequired().HasMaxLength(200);
        builder.Property(ri => ri.Unit).HasMaxLength(50);
        builder.Property(ri => ri.Category).HasMaxLength(50);
        builder.Property(ri => ri.Quantity).HasPrecision(10, 2);

        // Composite FK to Recipe (HouseholdId + RecipeId)
        builder.HasOne(ri => ri.Recipe)
            .WithMany(r => r.Ingredients)
            .HasForeignKey(ri => new { ri.HouseholdId, ri.RecipeId })
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

**MealPlanEntryConfiguration.cs** (demonstrates optional composite FK):
```csharp
public class MealPlanEntryConfiguration : IEntityTypeConfiguration<MealPlanEntry>
{
    public void Configure(EntityTypeBuilder<MealPlanEntry> builder)
    {
        builder.ToTable("MealPlanEntries");

        builder.HasKey(e => new { e.HouseholdId, e.MealPlanId, e.EntryId });
        builder.Property(e => e.EntryId).ValueGeneratedOnAdd();

        builder.Property(e => e.CustomMealName).HasMaxLength(200);
        builder.Property(e => e.Notes).HasMaxLength(500);

        // FK to MealPlan (composite)
        builder.HasOne(e => e.MealPlan)
            .WithMany(mp => mp.Entries)
            .HasForeignKey(e => new { e.HouseholdId, e.MealPlanId })
            .OnDelete(DeleteBehavior.Cascade);

        // Optional FK to Recipe (composite, nullable)
        builder.HasOne(e => e.Recipe)
            .WithMany()
            .HasForeignKey(e => new { e.HouseholdId, e.RecipeId })
            .OnDelete(DeleteBehavior.SetNull)
            .IsRequired(false);
    }
}
```

Create similar configurations for:
- HouseholdConfiguration (simple int PK)
- UserConfiguration (simple int PK, FK to Household, unique email index)
- MealPlanConfiguration (composite PK, FK to Household)
- ShoppingListConfiguration (composite PK, FK to Household, optional FK to MealPlan)
- ShoppingListItemConfiguration (composite PK/FK, optional FK to User)

Critical: ORDER OF PROPERTIES in HasForeignKey MUST match principal key order (HouseholdId always first).
  </action>
  <verify>
```bash
cd /home/sirm/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
```
Build succeeds. Grep for composite key patterns:
```bash
grep -r "HasKey.*new" Data/Configurations/
```
Should show composite key definitions in configuration files.
  </verify>
  <done>DbContext and 8 configuration classes created. All composite keys defined with HouseholdId first. Composite FKs correctly reference parent composite PKs.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Project builds**:
   ```bash
   cd /home/sirm/projects/github/family-coordination-app/src/FamilyCoordinationApp
   dotnet build
   ```

2. **All entities exist**:
   ```bash
   ls Data/Entities/*.cs | wc -l
   ```
   Should be 8 files.

3. **All configurations exist**:
   ```bash
   ls Data/Configurations/*.cs | wc -l
   ```
   Should be 8 files.

4. **Composite keys present**:
   ```bash
   grep -l "HasKey.*HouseholdId" Data/Configurations/*.cs | wc -l
   ```
   Should be 6+ (all tenant-owned entities).

5. **DbContextFactory registered**:
   ```bash
   grep "AddDbContextFactory" Program.cs
   ```
   Should show registration line.
</verification>

<success_criteria>
- Project compiles without errors
- 8 entity classes in Data/Entities/
- 8 configuration classes in Data/Configurations/
- All tenant-owned entities have HouseholdId in composite primary key
- Composite foreign keys reference parent composite keys (order matches)
- DbContextFactory registered in Program.cs
- No scoped DbContext registration (would cause Blazor Server issues)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>

---
phase: 04-shopping-list-core
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/Services/UnitConverter.cs
  - tests/FamilyCoordinationApp.Tests/Services/UnitConverterTests.cs
autonomous: true

must_haves:
  truths:
    - "Unit conversion correctly converts between volume units (tsp, tbsp, cup, fl oz, ml, l)"
    - "Unit conversion correctly converts between weight units (oz, lb, g, kg)"
    - "FindCommonUnit returns null for mixed unit families (volume + weight)"
    - "Count units (piece, can, bunch) do not convert to other families"
  artifacts:
    - path: "src/FamilyCoordinationApp/Services/UnitConverter.cs"
      provides: "Unit conversion service with lookup tables"
      exports: ["UnitConverter", "Convert", "FindCommonUnit", "CanConvert"]
    - path: "tests/FamilyCoordinationApp.Tests/Services/UnitConverterTests.cs"
      provides: "Unit conversion test coverage"
      min_lines: 80
  key_links:
    - from: "UnitConverter.Convert"
      to: "ConversionTable dictionary"
      via: "lookup and multiplication"
      pattern: "ConversionTable\\.TryGetValue"
---

<objective>
Implement TDD-driven UnitConverter service for cooking measurement conversions used during ingredient consolidation.

Purpose: Enables shopping list generation to combine quantities across different units (e.g., "1 cup milk" + "8 fl oz milk" = "2 cups milk").
Output: Tested UnitConverter service ready for use by ShoppingListGenerator.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-shopping-list-core/04-RESEARCH.md
</context>

<feature>
  <name>UnitConverter Service</name>
  <files>
    src/FamilyCoordinationApp/Services/UnitConverter.cs
    tests/FamilyCoordinationApp.Tests/Services/UnitConverterTests.cs
  </files>
  <behavior>
    Unit conversion for cooking measurements using lookup tables.

    Conversion families:
    - Volume: tsp, tbsp, cup, fl oz, ml, l (base: cup)
    - Weight: oz, lb, g, kg (base: gram)
    - Count: piece, can, bunch, clove (no cross-conversion)

    Test cases (input -> expected output):
    - Convert(1, "tbsp", "tsp") -> 3
    - Convert(1, "cup", "tbsp") -> 16
    - Convert(8, "fl oz", "cup") -> 1
    - Convert(16, "oz", "lb") -> 1
    - Convert(1000, "g", "kg") -> 1
    - Convert(1, "cup", "ml") -> 236.588
    - Convert(1, "lb", "g") -> 453.592
    - FindCommonUnit(["cup", "tbsp", "tsp"]) -> "cup" or similar volume unit
    - FindCommonUnit(["cup", "oz"]) -> null (mixed families)
    - CanConvert("cup", "tbsp") -> true
    - CanConvert("cup", "oz") -> false

    Edge cases:
    - Null or empty unit returns quantity unchanged
    - Unknown unit throws InvalidOperationException
    - Same unit returns quantity unchanged (no conversion needed)
    - Case-insensitive matching ("Cup" == "cup")
    - Plural handling ("cups" == "cup", "ounces" == "oz")
  </behavior>
  <implementation>
    1. Create UnitConverter class with static ConversionTable dictionary
    2. Each entry maps unit string to (family, toBase factor)
    3. Convert: normalize units, lookup both, verify same family, apply math
    4. FindCommonUnit: group units by family, return most frequent if all same family
    5. CanConvert: check if both units exist and share family
    6. NormalizeUnit: lowercase, trim, handle common plurals
  </implementation>
</feature>

<verification>
Run tests:
```bash
cd /home/[USER]/projects/github/family-coordination-app
dotnet test --filter "FullyQualifiedName~UnitConverterTests"
```

All tests pass with >90% method coverage for UnitConverter.
</verification>

<success_criteria>
- UnitConverter.Convert correctly converts within volume family
- UnitConverter.Convert correctly converts within weight family
- UnitConverter.FindCommonUnit returns common unit for same family
- UnitConverter.FindCommonUnit returns null for mixed families
- UnitConverter.CanConvert returns correct boolean for unit compatibility
- All edge cases handled (null, empty, unknown, same unit)
- Tests document expected behavior for future maintenance
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-list-core/04-01-SUMMARY.md`
</output>

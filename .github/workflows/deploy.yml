name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest code
        run: |
          cd ~/familyapp
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          echo "üì• Pulled commit: $(git rev-parse --short HEAD)"
          
      - name: Build Docker image
        run: |
          cd ~/familyapp
          docker build -t familyapp:latest .
          echo "üê≥ Built image: familyapp:latest"
          
      - name: Deploy containers
        run: |
          cd ~/familyapp
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          echo "üöÄ Containers started"
            
      - name: Health check
        run: |
          echo "‚è≥ Waiting for health check..."
          for i in {1..30}; do
            STATUS=$(docker inspect familyapp-app --format='{{.State.Health.Status}}' 2>/dev/null || echo "starting")
            if [ "$STATUS" = "healthy" ]; then
              echo "‚úÖ App is healthy!"
              exit 0
            fi
            echo "   Status: $STATUS ($i/30)"
            sleep 2
          done
          echo "‚ùå Health check timeout"
          docker logs familyapp-app --tail 50
          exit 1
          
      - name: Cleanup old images
        run: |
          docker image prune -f --filter "until=24h"
          echo "üßπ Cleaned up old images"

      - name: Notify Discord (Success)
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"‚úÖ Deploy Successful\",\"description\":\"**family-coordination-app** deployed to production\",\"color\":5025616,\"fields\":[{\"name\":\"Commit\",\"value\":\"\`$(cd ~/familyapp && git rev-parse --short HEAD)\`\",\"inline\":true},{\"name\":\"Branch\",\"value\":\"\`${{ github.ref_name }}\`\",\"inline\":true}],\"footer\":{\"text\":\"GitHub Actions\"}}]}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord (Failure)
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"‚ùå Deploy Failed\",\"description\":\"**family-coordination-app** deployment failed!\",\"color\":15158332,\"fields\":[{\"name\":\"Branch\",\"value\":\"\`${{ github.ref_name }}\`\",\"inline\":true},{\"name\":\"Run\",\"value\":\"[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",\"inline\":true}],\"footer\":{\"text\":\"GitHub Actions\"}}]}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

---
phase: 04-shopping-list-core
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/FamilyCoordinationApp/Services/ShoppingListGenerator.cs
  - src/FamilyCoordinationApp/Program.cs
  - src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
  - src/FamilyCoordinationApp/Data/Configurations/ShoppingListItemConfiguration.cs
  - src/FamilyCoordinationApp/Data/Migrations/AddShoppingListItemSourceFields.cs
autonomous: true

must_haves:
  truths:
    - "Generator creates shopping list from meal plan with consolidated ingredients"
    - "Identical ingredients (same name, same category) are combined with summed quantities"
    - "Different categories prevent consolidation (chicken breast in Meat vs chicken stock in Pantry)"
    - "Incompatible units prevent consolidation (volume vs weight)"
    - "Source recipes are tracked in consolidated items"
    - "Manual items are preserved when regenerating from meal plan"
  artifacts:
    - path: "src/FamilyCoordinationApp/Services/ShoppingListGenerator.cs"
      provides: "Shopping list generation from meal plan with consolidation"
      exports: ["IShoppingListGenerator", "ShoppingListGenerator", "ConsolidationResult"]
      min_lines: 120
  key_links:
    - from: "ShoppingListGenerator"
      to: "UnitConverter"
      via: "dependency injection"
      pattern: "_unitConverter\\.Convert"
    - from: "ShoppingListGenerator"
      to: "ShoppingListService"
      via: "dependency injection"
      pattern: "_shoppingListService\\.CreateShoppingListAsync"
    - from: "ShoppingListGenerator.ConsolidateIngredientsAsync"
      to: "RecipeIngredient"
      via: "meal plan entries"
      pattern: "GroupBy.*Name.*Category"
---

<objective>
Implement ShoppingListGenerator that creates shopping lists from meal plans with automatic ingredient consolidation using the UnitConverter.

Purpose: Core feature for SHOP-01 and SHOP-02 - generating shopping lists from meal plans with smart ingredient consolidation.
Output: Working generator that creates consolidated shopping lists from weekly meal plans.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-shopping-list-core/04-CONTEXT.md
@.planning/phases/04-shopping-list-core/04-RESEARCH.md
@src/FamilyCoordinationApp/Data/Entities/RecipeIngredient.cs
@src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source tracking fields to ShoppingListItem entity</name>
  <files>
    src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
    src/FamilyCoordinationApp/Data/Configurations/ShoppingListItemConfiguration.cs
  </files>
  <action>
Add fields to ShoppingListItem for tracking consolidation sources and manual edits:

1. In ShoppingListItem.cs add:
   - SourceRecipes: string? (comma-separated recipe names, e.g., "Pancakes, Mac & Cheese")
   - OriginalUnits: string? (if units were converted, e.g., "1 cup + 8 fl oz")
   - IsManuallyAdded: bool (true if user added, false if from meal plan)
   - QuantityDelta: decimal? (user adjustment: +1, -0.5, etc. for preserving during regeneration)
   - RecipeIngredientIds: string? (comma-separated IDs for tracking source, format: "1:2:3,1:2:5" for HouseholdId:RecipeId:IngredientId)
   - SortOrder: int (for custom ordering within category)

2. In ShoppingListItemConfiguration.cs add:
   - SourceRecipes: HasMaxLength(500), optional
   - OriginalUnits: HasMaxLength(200), optional
   - IsManuallyAdded: HasDefaultValue(false)
   - QuantityDelta: HasPrecision(10, 2), optional
   - RecipeIngredientIds: HasMaxLength(500), optional
   - SortOrder: IsRequired, HasDefaultValue(0)
  </action>
  <verify>
Build succeeds:
```bash
cd /home/[USER]/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```
  </verify>
  <done>
ShoppingListItem has source tracking fields and configuration is updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration for new ShoppingListItem fields</name>
  <files>src/FamilyCoordinationApp/Data/Migrations/</files>
  <action>
Generate and apply migration for new fields:

```bash
cd /home/[USER]/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet ef migrations add AddShoppingListItemSourceFields
```

Review generated migration to ensure it adds:
- SourceRecipes column (nvarchar(500), nullable)
- OriginalUnits column (nvarchar(200), nullable)
- IsManuallyAdded column (boolean, default false)
- QuantityDelta column (decimal(10,2), nullable)
- RecipeIngredientIds column (nvarchar(500), nullable)
- SortOrder column (int, default 0)
  </action>
  <verify>
Migration file exists and builds:
```bash
cd /home/[USER]/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```
  </verify>
  <done>
Migration for ShoppingListItem source fields is created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement ShoppingListGenerator with consolidation logic</name>
  <files>
    src/FamilyCoordinationApp/Services/ShoppingListGenerator.cs
    src/FamilyCoordinationApp/Program.cs
  </files>
  <action>
1. Create IShoppingListGenerator interface:
   - GenerateFromMealPlanAsync(householdId, mealPlanId, listName) -> ShoppingList
   - RegenerateShoppingListAsync(householdId, shoppingListId) -> ShoppingList
   - ConsolidateIngredientsAsync(ingredients, autoConsolidate=true) -> List<ConsolidationResult>

2. Create ConsolidationResult record/class:
   - Name: string
   - Quantity: decimal
   - Unit: string
   - Category: string
   - SourceRecipes: List<string>
   - OriginalUnits: string? (if converted)
   - RecipeIngredientIds: List<string> (HouseholdId:RecipeId:IngredientId format)

3. Implement ShoppingListGenerator:
   - Inject IDbContextFactory, IShoppingListService, UnitConverter, ILogger
   - GenerateFromMealPlanAsync:
     a. Load meal plan with entries, recipes, and ingredients
     b. Collect all RecipeIngredients from entries (skip entries with CustomMealName only)
     c. Call ConsolidateIngredientsAsync
     d. Create ShoppingList via IShoppingListService
     e. Add items from consolidation results
     f. Return created ShoppingList

   - ConsolidateIngredientsAsync:
     a. Group ingredients by (NormalizedName, Category)
     b. For each group:
        - Find common unit via UnitConverter.FindCommonUnit
        - If common unit found and autoConsolidate=true:
          * Convert all quantities to common unit
          * Sum quantities
          * Track source recipes and original units
        - Else: keep items separate
     c. Return list of ConsolidationResult

   - RegenerateShoppingListAsync:
     a. Load existing list with items
     b. Separate manual items (IsManuallyAdded=true) and edited items (QuantityDelta not null)
     c. Load linked meal plan
     d. Generate fresh consolidation from meal plan
     e. Apply quantity deltas to matching items
     f. Merge manual items back
     g. Update list items

   - NormalizeIngredientName helper:
     * Lowercase, trim
     * Remove common descriptors: "fresh", "organic", "chopped", "diced", "minced", "sliced"

4. Register in Program.cs:
   ```csharp
   builder.Services.AddScoped<UnitConverter>();
   builder.Services.AddScoped<IShoppingListGenerator, ShoppingListGenerator>();
   ```
  </action>
  <verify>
Build succeeds:
```bash
cd /home/[USER]/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```
  </verify>
  <done>
ShoppingListGenerator implements consolidation logic and is registered in DI.
  </done>
</task>

</tasks>

<verification>
Application builds:
```bash
cd /home/[USER]/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```

All new services are registered and injectable.
</verification>

<success_criteria>
- ShoppingListItem entity has source tracking fields
- Migration created for new fields
- ShoppingListGenerator consolidates ingredients by normalized name + category
- Unit conversion happens for compatible unit families
- Source recipes tracked in consolidated items
- Regeneration preserves manual items and quantity deltas
- Generator is registered in DI container
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-list-core/04-03-SUMMARY.md`
</output>

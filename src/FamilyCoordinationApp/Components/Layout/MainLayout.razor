@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Shared
@using FamilyCoordinationApp.Data
@using Microsoft.EntityFrameworkCore
@inherits LayoutComponentBase
@implements IDisposable

@inject PresenceService PresenceService
@inject PollingService PollingService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex align-center gap-4">
                        <OnlineUsers CurrentUserId="@_currentUserId" />
                        <SyncStatusIndicator />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@context.User.Identity?.Name</MudText>
                        <a href="/account/logout" class="mud-typography mud-typography-body2" style="color: var(--mud-palette-text-secondary);">Sign out</a>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>

        @* Offline/Error Banner *@
        @if (PollingService.Status == SyncStatus.Offline)
        {
            <MudAlert Severity="Severity.Warning" 
                      Dense="true" 
                      Class="mx-4 mt-2"
                      Icon="@Icons.Material.Filled.WifiOff">
                <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                    <span>You're offline. Changes may not sync until connection is restored.</span>
                </div>
            </MudAlert>
        }
        else if (PollingService.Status == SyncStatus.Error && PollingService.ConsecutiveErrors >= 3)
        {
            <MudAlert Severity="Severity.Error" 
                      Dense="true" 
                      Class="mx-4 mt-2"
                      Icon="@Icons.Material.Filled.ErrorOutline">
                <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                    <span>Sync error â€” please refresh the page</span>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Text" 
                               Color="Color.Inherit"
                               OnClick="RefreshPage">
                        Refresh
                    </MudButton>
                </div>
            </MudAlert>
        }

        <article class="content px-4">
            @Body
        </article>
        
        <!-- Footer -->
        <footer class="app-footer px-4 py-3">
            <div class="d-flex justify-center align-center gap-4 flex-wrap">
                <MudLink Href="/privacy" Color="Color.Secondary" Typo="Typo.caption">Privacy Policy</MudLink>
                <MudText Typo="Typo.caption" Color="Color.Secondary">â€¢</MudText>
                <MudLink Href="/terms" Color="Color.Secondary" Typo="Typo.caption">Terms of Service</MudLink>
                <MudText Typo="Typo.caption" Color="Color.Secondary">â€¢</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Â© @DateTime.Now.Year Heath Family</MudText>
            </div>
        </footer>
    </main>
</div>

<!-- Floating feedback button -->
<MudFab Color="Color.Tertiary"
        StartIcon="@Icons.Material.Filled.Feedback"
        OnClick="OpenFeedbackDialog"
        Style="position: fixed; bottom: 24px; left: 24px; z-index: 1000;"
        Size="Size.Medium"
        aria-label="Send feedback" />

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private int _currentUserId;
    private string? _currentUserPicture;
    private string _currentUserInitials = string.Empty;
    private string _currentUserName = string.Empty;
    private System.Timers.Timer? _heartbeatTimer;
    private bool _isDarkMode = false;  // Default to light mode for the warm, inviting look

    // Warm, inviting color palette for a family app
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2E7D32",           // Forest green - fresh, natural
            PrimaryContrastText = "#ffffff",
            Secondary = "#FF6F00",          // Warm orange - inviting, appetizing
            SecondaryContrastText = "#ffffff",
            Tertiary = "#5C6BC0",           // Soft indigo - calm accent
            Background = "#FAFAFA",
            Surface = "#FFFFFF",
            DrawerBackground = "#F5F5F5",
            AppbarBackground = "#2E7D32",
            AppbarText = "#FFFFFF",
            Success = "#43A047",
            Warning = "#FB8C00",
            Error = "#E53935",
            Info = "#1E88E5"
        },
        PaletteDark = new PaletteDark()
        {
            Black = "#1a1a1a",
            Background = "#121212",
            BackgroundGray = "#1e1e1e",
            Surface = "#1e1e1e",
            DrawerBackground = "#1a1a1a",
            DrawerText = "rgba(255,255,255, 0.87)",
            DrawerIcon = "rgba(255,255,255, 0.87)",
            AppbarBackground = "#1a1a1a",
            AppbarText = "rgba(255,255,255, 0.87)",
            TextPrimary = "rgba(255,255,255, 0.87)",
            TextSecondary = "rgba(255,255,255, 0.60)",
            ActionDefault = "#adadb1",
            ActionDisabled = "rgba(255,255,255, 0.26)",
            ActionDisabledBackground = "rgba(255,255,255, 0.12)",
            Divider = "rgba(255,255,255, 0.12)",
            DividerLight = "rgba(255,255,255, 0.06)",
            Primary = "#66BB6A",            // Lighter green for dark mode
            PrimaryContrastText = "#000000",
            Secondary = "#FFB74D",          // Softer orange for dark mode
            SecondaryContrastText = "#000000",
            Tertiary = "#7986CB",
            Info = "#42A5F5",
            Success = "#66BB6A",
            Warning = "#FFA726",
            Error = "#EF5350"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        StartHeartbeat();
        NavigationManager.LocationChanged += OnLocationChanged;
        PollingService.OnStatusChanged += OnSyncStatusChanged;
    }

    private void OnSyncStatusChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void RefreshPage()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        if (email != null)
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
            if (user != null)
            {
                _currentUserId = user.Id;
                _currentUserPicture = user.PictureUrl;
                _currentUserInitials = user.Initials;
                _currentUserName = user.DisplayName;
                SendHeartbeat();
            }
        }
    }

    private void StartHeartbeat()
    {
        // Send heartbeat every 30 seconds
        _heartbeatTimer = new System.Timers.Timer(30000);
        _heartbeatTimer.Elapsed += (_, _) => SendHeartbeat();
        _heartbeatTimer.AutoReset = true;
        _heartbeatTimer.Start();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        SendHeartbeat();
    }

    private void SendHeartbeat()
    {
        if (_currentUserId > 0)
        {
            var currentPage = new Uri(NavigationManager.Uri).AbsolutePath;
            PresenceService.Heartbeat(_currentUserId, _currentUserName, _currentUserPicture, _currentUserInitials, currentPage);
        }
    }

    private async Task OpenFeedbackDialog()
    {
        var parameters = new DialogParameters<FeedbackDialog>
        {
            { x => x.CurrentPage, NavigationManager.Uri }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<FeedbackDialog>("Send Feedback", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            Snackbar.Add("Thank you for your feedback!", Severity.Success);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        PollingService.OnStatusChanged -= OnSyncStatusChanged;
        _heartbeatTimer?.Stop();
        _heartbeatTimer?.Dispose();
        if (_currentUserId > 0)
        {
            PresenceService.UserDisconnected(_currentUserId);
        }
    }
}

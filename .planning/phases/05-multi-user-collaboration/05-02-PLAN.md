---
phase: 05-multi-user-collaboration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/Program.cs
  - src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs
autonomous: true

must_haves:
  truths:
    - "Google OAuth maps picture claim to User.PictureUrl"
    - "User initials computed from DisplayName on login"
    - "Existing users get picture/initials updated on subsequent logins"
  artifacts:
    - path: "src/FamilyCoordinationApp/Program.cs"
      provides: "Google OAuth picture claim mapping"
      contains: "urn:google:picture"
    - path: "src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs"
      provides: "Picture and initials storage on auth"
      contains: "PictureUrl"
  key_links:
    - from: "Google OAuth response"
      to: "User.PictureUrl"
      via: "ClaimActions.MapJsonKey + claim extraction in handler"
      pattern: "MapJsonKey.*picture"
---

<objective>
Configure Google OAuth to capture profile picture URL and compute user initials during authentication.

Purpose: Enable avatar display throughout the app by capturing Google profile pictures.
Output: Picture claim mapped, user profile updated on login.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-user-collaboration/05-RESEARCH.md
@src/FamilyCoordinationApp/Program.cs
@src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map Google OAuth picture claim</name>
  <files>src/FamilyCoordinationApp/Program.cs</files>
  <action>
In the .AddGoogle() configuration, add claim mapping for profile picture:

```csharp
// Map picture claim for avatar display
options.ClaimActions.MapJsonKey("urn:google:picture", "picture", "url");
```

This line should be added after the existing ClaimActions (MapJsonKey for email, name, etc.).

The "profile" scope is already requested which includes the picture.
  </action>
  <verify>Grep for "urn:google:picture" in Program.cs returns match</verify>
  <done>Google OAuth picture claim is mapped</done>
</task>

<task type="auto">
  <name>Task 2: Store picture URL and compute initials on login</name>
  <files>src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs</files>
  <action>
In WhitelistedEmailHandler.HandleRequirementAsync, after finding/creating the user, extract the picture claim and compute initials:

1. Extract picture claim:
```csharp
var pictureClaim = context.User.FindFirst("urn:google:picture")?.Value;
```

2. Compute initials from DisplayName:
```csharp
static string ComputeInitials(string displayName)
{
    if (string.IsNullOrWhiteSpace(displayName))
        return "?";

    var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
    if (parts.Length == 0)
        return "?";
    if (parts.Length == 1)
        return parts[0][0].ToString().ToUpperInvariant();

    // First and last name initials
    return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
}
```

3. Update user record with PictureUrl and Initials (both on create and update for existing users):
```csharp
user.PictureUrl = pictureClaim;
user.Initials = ComputeInitials(user.DisplayName);
```

This ensures picture URLs are updated if user changes their Google profile photo.
  </action>
  <verify>Login flow updates User.PictureUrl and User.Initials (test by logging in and checking database)</verify>
  <done>Picture URL and initials stored on user during authentication</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. Grep for "urn:google:picture" in Program.cs - Claim mapping exists
3. Grep for "PictureUrl" in WhitelistedEmailHandler.cs - User update includes picture
4. Grep for "Initials" in WhitelistedEmailHandler.cs - Initials computation exists
</verification>

<success_criteria>
- Google OAuth configuration includes picture claim mapping
- WhitelistedEmailHandler extracts picture and computes initials
- User entity updated with picture URL and initials on every login
- Solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-user-collaboration/05-02-SUMMARY.md`
</output>

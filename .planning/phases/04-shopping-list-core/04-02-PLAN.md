---
phase: 04-shopping-list-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/Services/ShoppingListService.cs
  - src/FamilyCoordinationApp/Program.cs
autonomous: true

must_haves:
  truths:
    - "ShoppingListService can create a new shopping list for a household"
    - "ShoppingListService can retrieve shopping lists with items"
    - "ShoppingListService can add manual items to shopping list"
    - "ShoppingListService can update item properties (name, quantity, checked state)"
    - "ShoppingListService can delete items from shopping list"
    - "ShoppingListService provides autocomplete suggestions from item history"
  artifacts:
    - path: "src/FamilyCoordinationApp/Services/ShoppingListService.cs"
      provides: "CRUD operations for shopping lists and items"
      exports: ["IShoppingListService", "ShoppingListService"]
      min_lines: 150
  key_links:
    - from: "ShoppingListService"
      to: "ApplicationDbContext"
      via: "IDbContextFactory injection"
      pattern: "_dbFactory\\.CreateDbContextAsync"
    - from: "ShoppingListService"
      to: "ShoppingList/ShoppingListItem entities"
      via: "EF Core queries"
      pattern: "context\\.ShoppingList"
---

<objective>
Implement ShoppingListService with CRUD operations for shopping lists and items, following established service patterns.

Purpose: Provides data access layer for shopping list management, used by both the generator and UI components.
Output: Fully functional ShoppingListService registered in DI container.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-shopping-list-core/04-RESEARCH.md
@src/FamilyCoordinationApp/Services/MealPlanService.cs
@src/FamilyCoordinationApp/Data/Entities/ShoppingList.cs
@src/FamilyCoordinationApp/Data/Entities/ShoppingListItem.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IShoppingListService interface and ShoppingListService implementation</name>
  <files>src/FamilyCoordinationApp/Services/ShoppingListService.cs</files>
  <action>
Create ShoppingListService following MealPlanService patterns:

1. Define IShoppingListService interface:
   - CreateShoppingListAsync(householdId, name, mealPlanId?) -> ShoppingList
   - GetShoppingListAsync(householdId, shoppingListId) -> ShoppingList?
   - GetActiveShoppingListsAsync(householdId) -> List<ShoppingList>
   - AddManualItemAsync(ShoppingListItem) -> ShoppingListItem
   - UpdateItemAsync(ShoppingListItem) -> void
   - DeleteItemAsync(householdId, shoppingListId, itemId) -> void
   - ToggleItemCheckedAsync(householdId, shoppingListId, itemId) -> ShoppingListItem
   - GetItemNameSuggestionsAsync(householdId, prefix, limit=10) -> List<string>
   - ArchiveShoppingListAsync(householdId, shoppingListId) -> void
   - ClearCheckedItemsAsync(householdId, shoppingListId) -> int (count deleted)

2. Implement ShoppingListService:
   - Inject IDbContextFactory<ApplicationDbContext> and ILogger
   - Use DbContextFactory pattern (await using var context = ...)
   - Implement composite key ID generation (get max + 1 within household scope)
   - Include navigation properties in queries (Items, MealPlan)
   - GetActiveShoppingListsAsync filters out IsArchived=true, orders by CreatedAt DESC

3. GetItemNameSuggestionsAsync implementation:
   - Search ALL shopping list items (including archived lists) for autocomplete
   - Use StartsWith for primary matches, Contains as fallback
   - Group by name, order by count descending (most frequently purchased first)
   - Return distinct names up to limit

4. ToggleItemCheckedAsync:
   - Toggle IsChecked flag
   - Set CheckedAt = DateTime.UtcNow when checking, null when unchecking
   - Return updated item for UI refresh

5. ClearCheckedItemsAsync:
   - Delete all items where IsChecked = true
   - Return count of deleted items for UI feedback
  </action>
  <verify>
Build succeeds:
```bash
cd /home/sirm/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```
  </verify>
  <done>
IShoppingListService interface and ShoppingListService implementation compile with all methods stubbed and implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register ShoppingListService in DI container</name>
  <files>src/FamilyCoordinationApp/Program.cs</files>
  <action>
Add service registration in Program.cs after other service registrations:

```csharp
builder.Services.AddScoped<IShoppingListService, ShoppingListService>();
```

Place near existing service registrations (IMealPlanService, IRecipeService, etc.).
  </action>
  <verify>
Build succeeds and app starts:
```bash
cd /home/sirm/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```
  </verify>
  <done>
ShoppingListService is registered in DI container and injectable into components.
  </done>
</task>

</tasks>

<verification>
Application builds without errors:
```bash
cd /home/sirm/projects/github/family-coordination-app
dotnet build src/FamilyCoordinationApp
```

Service interface methods are callable (compile-time verification).
</verification>

<success_criteria>
- IShoppingListService interface defines all required methods
- ShoppingListService implements all interface methods
- Service uses DbContextFactory pattern (thread-safe for Blazor Server)
- Composite key ID generation follows MealPlanService pattern
- Service is registered in DI container
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-list-core/04-02-SUMMARY.md`
</output>

---
phase: 03-meal-planning
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/FamilyCoordinationApp/Components/MealPlan/RecipePickerDialog.razor
  - src/FamilyCoordinationApp/Components/MealPlan/WeeklyCalendarView.razor
  - src/FamilyCoordinationApp/Components/MealPlan/WeeklyListView.razor
autonomous: true

must_haves:
  truths:
    - "RecipePickerDialog shows recipe autocomplete search"
    - "RecipePickerDialog allows entering custom meal name"
    - "RecipePickerDialog returns selected recipe ID or custom meal name"
    - "WeeklyCalendarView shows 7-column grid with 3 meal rows"
    - "WeeklyListView shows day-by-day expandable sections"
    - "Both views use MealSlot component for meal display"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/MealPlan/RecipePickerDialog.razor"
      provides: "Dialog for selecting recipe or entering custom meal"
      min_lines: 60
    - path: "src/FamilyCoordinationApp/Components/MealPlan/WeeklyCalendarView.razor"
      provides: "7-day grid layout for desktop"
      min_lines: 50
    - path: "src/FamilyCoordinationApp/Components/MealPlan/WeeklyListView.razor"
      provides: "Day-by-day list layout for mobile"
      min_lines: 40
  key_links:
    - from: "src/FamilyCoordinationApp/Components/MealPlan/RecipePickerDialog.razor"
      to: "IRecipeService"
      via: "Injection for recipe search"
      pattern: "@inject IRecipeService"
    - from: "src/FamilyCoordinationApp/Components/MealPlan/WeeklyCalendarView.razor"
      to: "MealSlot"
      via: "Component usage"
      pattern: "<MealSlot"
    - from: "src/FamilyCoordinationApp/Components/MealPlan/WeeklyListView.razor"
      to: "MealSlot"
      via: "Component usage"
      pattern: "<MealSlot"
---

<objective>
Create RecipePickerDialog and the two view components (WeeklyCalendarView for desktop, WeeklyListView for mobile).

Purpose: Dialog allows meal assignment via recipe search or custom entry. Views render the weekly meal plan in different layouts optimized for screen size.

Output: Three components ready for use in the main MealPlan page.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md

# Dialog pattern reference
@src/FamilyCoordinationApp/Components/Pages/Settings/CategoryEditDialog.razor

# MealSlot to use
@src/FamilyCoordinationApp/Components/MealPlan/MealSlot.razor

# RecipeService for search
@src/FamilyCoordinationApp/Services/RecipeService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecipePickerDialog for meal selection</name>
  <files>src/FamilyCoordinationApp/Components/MealPlan/RecipePickerDialog.razor</files>
  <action>
Create RecipePickerDialog.razor:

**Injections:**
- `@inject IRecipeService RecipeService`
- `MudDialogInstance MudDialog` via CascadingParameter

**Parameters:**
- `int HouseholdId` - For recipe queries

**State:**
- `Recipe? _selectedRecipe`
- `string? _customMealName`
- `bool _isCustomTab` - Track which tab is active

**Layout:**
MudDialogContent with MudTabs:

**Tab 1: "Pick Recipe"**
- MudAutocomplete<Recipe>
  - Label="Search recipes"
  - @bind-Value="_selectedRecipe"
  - SearchFunc="SearchRecipes" (async, takes string, returns IEnumerable<Recipe>)
  - ToStringFunc="@(r => r?.Name ?? "")"
  - DebounceInterval="300"
  - MinCharacters="0" (show recent recipes immediately)
  - ItemTemplate showing recipe image thumbnail (40x40) and name
  - Clearable="true"

**Tab 2: "Custom Meal"**
- MudTextField @bind-Value="_customMealName"
  - Label="Custom meal name"
  - Placeholder="e.g., Leftovers, Eating out, Takeout"
  - Immediate="true"

**MudDialogActions:**
- Cancel button: `OnClick="() => MudDialog.Cancel()"`
- Add button: Color.Primary, OnClick="Submit", Disabled when nothing selected

**Logic:**
```csharp
// Result class to return
public class MealSelection
{
    public int? RecipeId { get; set; }
    public string? CustomMealName { get; set; }
}

private bool CanSubmit => _selectedRecipe != null || !string.IsNullOrWhiteSpace(_customMealName);

private async Task<IEnumerable<Recipe>> SearchRecipes(string value, CancellationToken ct)
{
    var recipes = await RecipeService.GetRecipesAsync(HouseholdId, value, ct);
    return recipes;
}

private void Submit()
{
    var result = new MealSelection
    {
        RecipeId = _selectedRecipe?.RecipeId,
        CustomMealName = _selectedRecipe == null ? _customMealName?.Trim() : null
    };
    MudDialog.Close(DialogResult.Ok(result));
}
```

**Important:** Define MealSelection class at the bottom of the file or in a separate Models folder.
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
File contains MudAutocomplete and MudTabs
  </verify>
  <done>
RecipePickerDialog allows recipe search or custom meal entry and returns MealSelection result
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WeeklyCalendarView for desktop grid layout</name>
  <files>src/FamilyCoordinationApp/Components/MealPlan/WeeklyCalendarView.razor</files>
  <action>
Create WeeklyCalendarView.razor:

**Parameters:**
- `DateOnly WeekStartDate` - First day (Monday) of the week
- `List<MealPlanEntry> Entries` - All entries for this week
- `EventCallback<(DateOnly Date, MealType MealType)> OnSlotClick` - When empty/filled slot clicked
- `EventCallback<MealPlanEntry> OnRemoveEntry` - When remove button clicked
- `EventCallback<Recipe> OnViewRecipe` - When recipe name clicked

**Layout using CSS Grid:**
```html
<div class="meal-plan-grid">
    <!-- Header row: day names + dates -->
    <div class="grid-corner"></div> <!-- Empty corner for meal type labels -->
    @foreach (var day in WeekDays)
    {
        <div class="day-header @(day == DateOnly.FromDateTime(DateTime.Today) ? "today" : "")">
            <MudText Typo="Typo.subtitle2">@day.DayOfWeek.ToString().Substring(0, 3)</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">@day.ToString("MMM d")</MudText>
        </div>
    }

    <!-- Meal rows: Breakfast, Lunch, Dinner -->
    @foreach (var mealType in new[] { MealType.Breakfast, MealType.Lunch, MealType.Dinner })
    {
        <div class="meal-label">
            <MudText Typo="Typo.caption">@mealType</MudText>
        </div>
        @foreach (var day in WeekDays)
        {
            <MealSlot Date="@day"
                      MealType="@mealType"
                      Entry="@GetEntry(day, mealType)"
                      OnClick="@(() => OnSlotClick.InvokeAsync((day, mealType)))"
                      OnRemove="@(() => HandleRemove(day, mealType))"
                      OnViewRecipe="@HandleViewRecipe" />
        }
    }
</div>
```

**Helper methods:**
```csharp
private DateOnly[] WeekDays => Enumerable.Range(0, 7)
    .Select(i => WeekStartDate.AddDays(i))
    .ToArray();

private MealPlanEntry? GetEntry(DateOnly date, MealType mealType)
{
    return Entries?.FirstOrDefault(e => e.Date == date && e.MealType == mealType);
}

private async Task HandleRemove(DateOnly date, MealType mealType)
{
    var entry = GetEntry(date, mealType);
    if (entry != null)
    {
        await OnRemoveEntry.InvokeAsync(entry);
    }
}

private async Task HandleViewRecipe(MealPlanEntry entry)
{
    if (entry?.Recipe != null)
    {
        await OnViewRecipe.InvokeAsync(entry.Recipe);
    }
}
```

**CSS (in <style> block):**
```css
.meal-plan-grid {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    gap: 4px;
}

.grid-corner {
    /* Empty top-left corner */
}

.day-header {
    text-align: center;
    padding: 8px 4px;
}

.day-header.today {
    background-color: var(--mud-palette-primary);
    border-radius: 4px;
}

.meal-label {
    display: flex;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
}
```
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
File contains CSS Grid layout with 7 columns
  </verify>
  <done>
WeeklyCalendarView renders 7-day grid with 3 meal rows using MealSlot components
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WeeklyListView for mobile layout</name>
  <files>src/FamilyCoordinationApp/Components/MealPlan/WeeklyListView.razor</files>
  <action>
Create WeeklyListView.razor:

**Parameters:** Same as WeeklyCalendarView:
- `DateOnly WeekStartDate`
- `List<MealPlanEntry> Entries`
- `EventCallback<(DateOnly Date, MealType MealType)> OnSlotClick`
- `EventCallback<MealPlanEntry> OnRemoveEntry`
- `EventCallback<Recipe> OnViewRecipe`

**Layout using MudExpansionPanels (one per day):**
```html
<MudExpansionPanels MultiExpansion="true">
    @foreach (var day in WeekDays)
    {
        var isToday = day == DateOnly.FromDateTime(DateTime.Today);
        <MudExpansionPanel IsInitiallyExpanded="@isToday"
                          Class="@(isToday ? "today-panel" : "")">
            <TitleContent>
                <div class="d-flex justify-space-between align-center w-100">
                    <div>
                        <MudText Typo="Typo.subtitle1">@day.DayOfWeek</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@day.ToString("MMM d")</MudText>
                    </div>
                    @if (isToday)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Today</MudChip>
                    }
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @GetDayMealCount(day) meals
                    </MudText>
                </div>
            </TitleContent>
            <ChildContent>
                @foreach (var mealType in new[] { MealType.Breakfast, MealType.Lunch, MealType.Dinner })
                {
                    <div class="d-flex align-center gap-2 py-2">
                        <MudText Typo="Typo.body2" Class="meal-type-label" Style="width: 80px;">
                            @mealType
                        </MudText>
                        <div class="flex-grow-1">
                            <MealSlot Date="@day"
                                      MealType="@mealType"
                                      Entry="@GetEntry(day, mealType)"
                                      OnClick="@(() => OnSlotClick.InvokeAsync((day, mealType)))"
                                      OnRemove="@(() => HandleRemove(day, mealType))"
                                      OnViewRecipe="@HandleViewRecipe" />
                        </div>
                    </div>
                }
            </ChildContent>
        </MudExpansionPanel>
    }
</MudExpansionPanels>
```

**Helper methods:** Same as WeeklyCalendarView plus:
```csharp
private int GetDayMealCount(DateOnly day)
{
    return Entries?.Count(e => e.Date == day) ?? 0;
}
```

**CSS:**
```css
.today-panel {
    border-left: 3px solid var(--mud-palette-primary);
}

.meal-type-label {
    font-weight: 500;
    color: var(--mud-palette-text-secondary);
}
```
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
File contains MudExpansionPanels with day-based grouping
  </verify>
  <done>
WeeklyListView renders day-by-day expandable panels with meal slots for mobile view
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` succeeds
2. All three files exist in Components/MealPlan/
3. RecipePickerDialog uses MudAutocomplete for recipe search
4. WeeklyCalendarView uses CSS Grid with 7 columns
5. WeeklyListView uses MudExpansionPanels for day grouping
6. Both views use MealSlot component
</verification>

<success_criteria>
- RecipePickerDialog returns MealSelection with RecipeId or CustomMealName
- WeeklyCalendarView shows 21 slots (7 days x 3 meals)
- WeeklyListView shows 7 expandable panels with 3 slots each
- Both views wire up OnSlotClick, OnRemoveEntry, OnViewRecipe callbacks
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-03-SUMMARY.md`
</output>

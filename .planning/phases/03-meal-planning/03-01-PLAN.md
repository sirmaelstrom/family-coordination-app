---
phase: 03-meal-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FamilyCoordinationApp/Services/MealPlanService.cs
  - src/FamilyCoordinationApp/Program.cs
autonomous: true

must_haves:
  truths:
    - "MealPlan is created automatically when accessing a new week"
    - "MealPlanEntry can be added with recipe or custom meal name"
    - "MealPlanEntry can be removed from plan"
    - "Existing entries are returned when loading a week's meal plan"
  artifacts:
    - path: "src/FamilyCoordinationApp/Services/MealPlanService.cs"
      provides: "Meal plan CRUD operations"
      exports: ["IMealPlanService", "MealPlanService"]
      min_lines: 100
  key_links:
    - from: "src/FamilyCoordinationApp/Services/MealPlanService.cs"
      to: "ApplicationDbContext"
      via: "IDbContextFactory injection"
      pattern: "IDbContextFactory<ApplicationDbContext>"
    - from: "src/FamilyCoordinationApp/Program.cs"
      to: "MealPlanService"
      via: "DI registration"
      pattern: "AddScoped<IMealPlanService, MealPlanService>"
---

<objective>
Create MealPlanService for weekly meal plan CRUD operations following existing RecipeService patterns.

Purpose: Backend service enabling meal plan data access for UI components. Uses get-or-create pattern for MealPlan entities and provides CRUD for MealPlanEntry.

Output: Working IMealPlanService registered in DI with methods for getting/creating meal plans and adding/removing entries.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md

# Existing service pattern to follow
@src/FamilyCoordinationApp/Services/RecipeService.cs

# Data model to use
@src/FamilyCoordinationApp/Data/Entities/MealPlan.cs
@src/FamilyCoordinationApp/Data/Entities/MealPlanEntry.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MealPlanService with get-or-create and CRUD operations</name>
  <files>src/FamilyCoordinationApp/Services/MealPlanService.cs</files>
  <action>
Create MealPlanService following RecipeService patterns:

**Interface IMealPlanService:**
- `Task<MealPlan> GetOrCreateMealPlanAsync(int householdId, DateOnly weekStart, CancellationToken ct)`
- `Task<MealPlanEntry> AddMealAsync(int householdId, DateOnly date, MealType mealType, int? recipeId, string? customMealName, CancellationToken ct)`
- `Task RemoveMealAsync(int householdId, int mealPlanId, int entryId, CancellationToken ct)`
- `DateOnly GetWeekStartDate(DateOnly date)` - Calculate Monday of week
- `DateOnly[] GetWeekDays(DateOnly weekStart)` - Return array of 7 days

**Implementation details:**
1. Inject IDbContextFactory<ApplicationDbContext> and ILogger<MealPlanService>
2. GetOrCreateMealPlanAsync:
   - Query MealPlan with .Include(mp => mp.Entries).ThenInclude(e => e.Recipe)
   - If null, create new MealPlan with next MealPlanId for household
   - Return existing or newly created MealPlan
3. AddMealAsync:
   - Get or create MealPlan for the week containing the date
   - Check for existing entry at same date + mealType - update if exists, create if not
   - Use next EntryId within the MealPlan scope
   - Either RecipeId OR CustomMealName should be set, not both
4. RemoveMealAsync:
   - Find entry by composite key (HouseholdId, MealPlanId, EntryId)
   - Hard delete (not soft delete for entries)
5. GetWeekStartDate: `(7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7` then subtract from date
6. GetWeekDays: Enumerable.Range(0, 7).Select(i => weekStart.AddDays(i)).ToArray()

**Important:** Use same patterns as RecipeService:
- `await using var context = await _dbFactory.CreateDbContextAsync(ct);`
- Logging with structured parameters
- Include Recipe navigation when loading entries
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
Service file exists and contains IMealPlanService interface and MealPlanService class
  </verify>
  <done>
MealPlanService implements all 5 methods with proper household isolation and composite key handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Register MealPlanService in dependency injection</name>
  <files>src/FamilyCoordinationApp/Program.cs</files>
  <action>
Add MealPlanService registration to Program.cs:

1. Add `builder.Services.AddScoped<IMealPlanService, MealPlanService>();` near other service registrations (ImageService, RecipeService, etc.)
2. Ensure using statement for FamilyCoordinationApp.Services namespace is present (should already exist)

Place the registration in the same section as other scoped services.
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
Grep Program.cs for IMealPlanService registration
  </verify>
  <done>
MealPlanService is registered in DI and can be injected into Blazor components
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for week calculation methods</name>
  <files>tests/FamilyCoordinationApp.Tests/Services/MealPlanServiceTests.cs</files>
  <action>
Create test file for MealPlanService week calculation methods:

1. Create tests directory if needed: `tests/FamilyCoordinationApp.Tests/Services/`
2. Test GetWeekStartDate:
   - Monday input returns same day
   - Sunday input returns previous Monday
   - Wednesday input returns Monday of same week
   - Year boundary (Jan 1 on Wednesday returns Dec Monday)
3. Test GetWeekDays:
   - Returns exactly 7 days
   - First day matches input weekStart
   - Last day is 6 days after weekStart
   - Days are in sequential order

**Note:** These are pure functions that don't need database mocking. Create minimal service instance by mocking IDbContextFactory and ILogger.

If test project doesn't exist yet, skip this task and note in summary that tests should be added when test infrastructure is set up.
  </action>
  <verify>
If test project exists: `dotnet test tests/FamilyCoordinationApp.Tests`
If not: Note in summary that test project setup is deferred
  </verify>
  <done>
Week calculation methods have test coverage or deferral is documented
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` succeeds
2. MealPlanService.cs exists with all 5 interface methods implemented
3. Program.cs registers IMealPlanService
4. Service follows IDbContextFactory pattern from RecipeService
</verification>

<success_criteria>
- IMealPlanService interface defines 5 methods (GetOrCreateMealPlanAsync, AddMealAsync, RemoveMealAsync, GetWeekStartDate, GetWeekDays)
- MealPlanService implementation uses IDbContextFactory pattern
- Service is registered in DI
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-01-SUMMARY.md`
</output>

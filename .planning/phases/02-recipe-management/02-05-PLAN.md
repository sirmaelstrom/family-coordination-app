---
phase: 02-recipe-management
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/FamilyCoordinationApp/Components/Pages/Recipes.razor
  - src/FamilyCoordinationApp/Components/Recipe/RecipeCard.razor
  - src/FamilyCoordinationApp/Components/Layout/NavMenu.razor
autonomous: true

must_haves:
  truths:
    - "User can view list of recipes in card grid layout"
    - "User can search recipes by name"
    - "User can click card to expand and see full details"
    - "Expanded card shows Edit, Delete, and Add to Meal Plan buttons"
    - "Empty state shows friendly prompt with Add Recipe button"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Pages/Recipes.razor"
      provides: "Recipe list page"
      contains: "RecipeCard"
    - path: "src/FamilyCoordinationApp/Components/Recipe/RecipeCard.razor"
      provides: "Recipe card component"
      contains: "MudCard"
  key_links:
    - from: "Recipes.razor"
      to: "RecipeService"
      via: "GetRecipesAsync"
      pattern: "GetRecipesAsync"
    - from: "RecipeCard"
      to: "Expanded state"
      via: "click handler"
      pattern: "ToggleExpanded"
---

<objective>
Create recipe list page with card-based grid layout, search functionality, and in-place card expansion.

Purpose: Provide the main recipe browsing interface where users can view, search, and manage their recipes.
Output: Recipes.razor page with RecipeCard components in responsive grid layout.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-recipe-management/02-CONTEXT.md
@.planning/phases/02-recipe-management/02-RESEARCH.md

# RecipeService from Plan 03
@src/FamilyCoordinationApp/Services/RecipeService.cs

# MudBlazor setup from Plan 01
@src/FamilyCoordinationApp/Components/_Imports.razor

# Recipe entity
@src/FamilyCoordinationApp/Data/Entities/Recipe.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecipeCard component with expand/collapse</name>
  <files>
    src/FamilyCoordinationApp/Components/Recipe/RecipeCard.razor
  </files>
  <action>
Create RecipeCard.razor component:

```razor
@using FamilyCoordinationApp.Data.Entities
@using Markdig

<MudCard Elevation="@(IsExpanded ? 4 : 2)"
         Class="@CardClass"
         Style="transition: all 0.3s ease;">
    <MudCardMedia Image="@GetImageUrl()"
                  Height="200"
                  Style="cursor: pointer; object-fit: cover;"
                  @onclick="OnCardClick" />

    <MudCardContent Style="cursor: pointer;" @onclick="OnCardClick">
        <MudText Typo="Typo.h6" Class="mb-1">@Recipe.Name</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @GetIngredientPreview()
        </MudText>

        @if (!string.IsNullOrWhiteSpace(Recipe.Description) && !IsExpanded)
        {
            <MudText Typo="Typo.body2" Class="mt-2" Style="@DescriptionStyle">
                @TruncateText(Recipe.Description, 100)
            </MudText>
        }
    </MudCardContent>

    @if (IsExpanded)
    {
        <MudCardContent>
            @if (!string.IsNullOrWhiteSpace(Recipe.Description))
            {
                <MudText Typo="Typo.body1" Class="mb-3">@Recipe.Description</MudText>
            }

            <MudDivider Class="mb-3" />

            <div class="d-flex gap-4 mb-3">
                @if (Recipe.PrepTimeMinutes.HasValue)
                {
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Small" Class="mr-1" />
                        <MudText Typo="Typo.body2">Prep: @Recipe.PrepTimeMinutes min</MudText>
                    </div>
                }
                @if (Recipe.CookTimeMinutes.HasValue)
                {
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Size="Size.Small" Class="mr-1" />
                        <MudText Typo="Typo.body2">Cook: @Recipe.CookTimeMinutes min</MudText>
                    </div>
                }
                @if (Recipe.Servings.HasValue)
                {
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-1" />
                        <MudText Typo="Typo.body2">Serves: @Recipe.Servings</MudText>
                    </div>
                }
            </div>

            <MudText Typo="Typo.subtitle2" Class="mb-2">Ingredients</MudText>
            <MudList T="string" Dense="true" Class="mb-3">
                @foreach (var ingredient in Recipe.Ingredients.OrderBy(i => i.SortOrder))
                {
                    <MudListItem Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <span>@FormatIngredient(ingredient)</span>
                        @if (!string.IsNullOrWhiteSpace(ingredient.Notes))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                                (@ingredient.Notes)
                            </MudText>
                        }
                    </MudListItem>
                }
            </MudList>

            @if (!string.IsNullOrWhiteSpace(Recipe.Instructions))
            {
                <MudText Typo="Typo.subtitle2" Class="mb-2">Instructions</MudText>
                <div class="recipe-instructions">
                    @((MarkupString)RenderMarkdown(Recipe.Instructions))
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Recipe.SourceUrl))
            {
                <MudLink Href="@Recipe.SourceUrl" Target="_blank" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="mr-1" />
                    View Original Recipe
                </MudLink>
            }
        </MudCardContent>

        <MudCardActions Class="justify-space-between">
            <div>
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           OnClick="OnEdit">
                    Edit
                </MudButton>
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="OnDelete">
                    Delete
                </MudButton>
            </div>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.CalendarMonth"
                       OnClick="OnAddToMealPlan"
                       Disabled="true">
                Add to Meal Plan
            </MudButton>
        </MudCardActions>
    }
</MudCard>

<style>
    .recipe-instructions {
        line-height: 1.6;
    }
    .recipe-instructions p {
        margin-bottom: 0.5rem;
    }
    .recipe-instructions ol, .recipe-instructions ul {
        padding-left: 1.5rem;
    }
</style>

@code {
    [Parameter] public Recipe Recipe { get; set; } = default!;
    [Parameter] public bool IsExpanded { get; set; }
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public EventCallback OnEditClicked { get; set; }
    [Parameter] public EventCallback OnDeleteClicked { get; set; }
    [Parameter] public EventCallback OnAddToMealPlanClicked { get; set; }

    private static readonly MarkdownPipeline MarkdownPipeline = new MarkdownPipelineBuilder()
        .DisableHtml() // Security: prevent XSS
        .UseAdvancedExtensions()
        .Build();

    // Food emoji placeholders by category heuristic
    private static readonly string[] FoodEmojis = { "plate_with_cutlery", "cooking", "shallow_pan_of_food", "stew", "green_salad", "spaghetti" };

    private string CardClass => IsExpanded
        ? "recipe-card recipe-card-expanded"
        : "recipe-card";

    private string DescriptionStyle => "display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;";

    private string GetImageUrl()
    {
        if (!string.IsNullOrWhiteSpace(Recipe.ImagePath))
        {
            return Recipe.ImagePath;
        }

        // Return empty for now - component will show placeholder via MudCardMedia's fallback
        // Future: Generate data URL for emoji placeholder
        return "/images/recipe-placeholder.svg";
    }

    private string GetIngredientPreview()
    {
        var mainIngredients = Recipe.Ingredients
            .OrderBy(i => i.SortOrder)
            .Take(3)
            .Select(i => i.Name);

        var preview = string.Join(", ", mainIngredients);

        if (Recipe.Ingredients.Count > 3)
        {
            preview += $" +{Recipe.Ingredients.Count - 3} more";
        }

        return preview;
    }

    private static string FormatIngredient(RecipeIngredient ing)
    {
        var parts = new List<string>();

        if (ing.Quantity.HasValue)
        {
            parts.Add(FormatQuantity(ing.Quantity.Value));
        }

        if (!string.IsNullOrWhiteSpace(ing.Unit))
        {
            parts.Add(ing.Unit);
        }

        parts.Add(ing.Name);

        return string.Join(" ", parts);
    }

    private static string FormatQuantity(decimal qty)
    {
        if (qty == 0.25m) return "1/4";
        if (qty == 0.5m) return "1/2";
        if (qty == 0.75m) return "3/4";
        if (qty == 0.33m || qty == (1m / 3m)) return "1/3";
        if (qty == 0.67m || qty == (2m / 3m)) return "2/3";

        var whole = Math.Truncate(qty);
        var frac = qty - whole;

        if (frac == 0) return whole.ToString("0.##");

        if (whole > 0)
        {
            if (frac == 0.25m) return $"{whole:0} 1/4";
            if (frac == 0.5m) return $"{whole:0} 1/2";
            if (frac == 0.75m) return $"{whole:0} 3/4";
        }

        return qty.ToString("0.##");
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrWhiteSpace(text) || text.Length <= maxLength)
            return text ?? string.Empty;

        return text[..(maxLength - 3)] + "...";
    }

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrWhiteSpace(markdown))
            return string.Empty;

        try
        {
            return Markdown.ToHtml(markdown, MarkdownPipeline);
        }
        catch
        {
            return $"<pre>{System.Net.WebUtility.HtmlEncode(markdown)}</pre>";
        }
    }

    private async Task OnCardClick()
    {
        await OnClick.InvokeAsync();
    }

    private async Task OnEdit()
    {
        await OnEditClicked.InvokeAsync();
    }

    private async Task OnDelete()
    {
        await OnDeleteClicked.InvokeAsync();
    }

    private async Task OnAddToMealPlan()
    {
        await OnAddToMealPlanClicked.InvokeAsync();
    }
}
```
  </action>
  <verify>
    Run `dotnet build src/FamilyCoordinationApp` - should compile without errors.
  </verify>
  <done>RecipeCard component created with expand/collapse, markdown rendering, and action buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create Recipes page with card grid and search</name>
  <files>
    src/FamilyCoordinationApp/Components/Pages/Recipes.razor
  </files>
  <action>
Create Recipes.razor page:

```razor
@page "/recipes"
@attribute [Authorize]

@using FamilyCoordinationApp.Data
@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Recipe
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@inject IRecipeService RecipeService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Recipes - Family Coordination</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Recipes</MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/recipes/new">
            Add Recipe
        </MudButton>
    </div>

    <MudTextField @bind-Value="_searchTerm"
                  Placeholder="Search recipes..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="SearchRecipes"
                  Variant="Variant.Outlined"
                  Class="mb-4"
                  FullWidth="false"
                  Style="max-width: 400px;" />

    @if (_loading)
    {
        <MudGrid>
            @for (int i = 0; i < 6; i++)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Class="mt-2" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (_recipes.Count == 0)
    {
        <MudPaper Class="pa-8 text-center" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.MenuBook"
                     Size="Size.Large"
                     Color="Color.Secondary"
                     Class="mb-4"
                     Style="font-size: 80px;" />
            <MudText Typo="Typo.h5" Class="mb-2">No recipes yet</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                @if (string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <text>Start building your recipe collection by adding your first recipe.</text>
                }
                else
                {
                    <text>No recipes match "@_searchTerm". Try a different search term.</text>
                }
            </MudText>
            @if (string.IsNullOrWhiteSpace(_searchTerm))
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.Add"
                           Href="/recipes/new">
                    Add Your First Recipe
                </MudButton>
            }
        </MudPaper>
    }
    else
    {
        <MudGrid>
            @foreach (var recipe in _recipes)
            {
                <MudItem xs="12" sm="6" md="4">
                    <RecipeCard Recipe="recipe"
                                IsExpanded="_expandedRecipeId == recipe.RecipeId"
                                OnClick="() => ToggleExpanded(recipe.RecipeId)"
                                OnEditClicked="() => EditRecipe(recipe)"
                                OnDeleteClicked="() => DeleteRecipe(recipe)"
                                OnAddToMealPlanClicked="() => AddToMealPlan(recipe)" />
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthState { get; set; }

    private List<Recipe> _recipes = new();
    private string _searchTerm = string.Empty;
    private int? _expandedRecipeId;
    private bool _loading = true;
    private int _householdId;

    protected override async Task OnInitializedAsync()
    {
        await LoadHouseholdId();
        await LoadRecipes();
    }

    private async Task LoadHouseholdId()
    {
        if (AuthState == null) return;

        var authState = await AuthState;
        var email = authState.User.FindFirstValue(ClaimTypes.Email);

        if (string.IsNullOrEmpty(email)) return;

        await using var context = await DbFactory.CreateDbContextAsync();
        var user = await context.Users
            .FirstOrDefaultAsync(u => u.Email == email);

        if (user != null)
        {
            _householdId = user.HouseholdId;
        }
    }

    private async Task LoadRecipes()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _recipes = await RecipeService.GetRecipesAsync(
                _householdId,
                string.IsNullOrWhiteSpace(_searchTerm) ? null : _searchTerm);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SearchRecipes()
    {
        await LoadRecipes();
    }

    private void ToggleExpanded(int recipeId)
    {
        _expandedRecipeId = _expandedRecipeId == recipeId ? null : recipeId;
    }

    private void EditRecipe(Recipe recipe)
    {
        Navigation.NavigateTo($"/recipes/edit/{recipe.RecipeId}");
    }

    private async Task DeleteRecipe(Recipe recipe)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Recipe",
            $"Are you sure you want to delete \"{recipe.Name}\"? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await RecipeService.DeleteRecipeAsync(_householdId, recipe.RecipeId);
                _recipes.Remove(recipe);
                _expandedRecipeId = null;
                Snackbar.Add($"Recipe \"{recipe.Name}\" deleted", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete recipe: {ex.Message}", Severity.Error);
            }
        }
    }

    private void AddToMealPlan(Recipe recipe)
    {
        // Placeholder for Phase 3
        Snackbar.Add("Meal planning coming in Phase 3!", Severity.Info);
    }
}
```
  </action>
  <verify>
    Run `dotnet build src/FamilyCoordinationApp` - should compile without errors.
  </verify>
  <done>Recipes page created with card grid, search, expand/collapse, and delete confirmation</done>
</task>

<task type="auto">
  <name>Task 3: Add Recipes link to navigation menu and create placeholder image</name>
  <files>
    src/FamilyCoordinationApp/Components/Layout/NavMenu.razor
    src/FamilyCoordinationApp/wwwroot/images/recipe-placeholder.svg
  </files>
  <action>
1. Update NavMenu.razor to add Recipes link. Find the navigation section and add:
   ```razor
   <MudNavLink Href="/recipes" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.MenuBook">
       Recipes
   </MudNavLink>
   ```

   If the NavMenu uses a different structure (not MudNavLink), adapt accordingly. The key is adding a link to `/recipes` with a book/menu icon.

2. Create placeholder image for recipes without images.

   Create directory `wwwroot/images` if it doesn't exist.

   Create recipe-placeholder.svg:
   ```xml
   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200" fill="none">
     <rect width="400" height="200" fill="#2d2d3d"/>
     <text x="200" y="100" text-anchor="middle" dominant-baseline="middle" font-size="64">üçΩÔ∏è</text>
     <text x="200" y="150" text-anchor="middle" font-family="system-ui" font-size="16" fill="#888">No image</text>
   </svg>
   ```
  </action>
  <verify>
    1. Run `dotnet build src/FamilyCoordinationApp` - should compile without errors.
    2. Verify recipe-placeholder.svg exists in wwwroot/images/
  </verify>
  <done>Recipes navigation added, placeholder image created</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` compiles without errors
2. RecipeCard.razor exists with expand/collapse functionality
3. Recipes.razor exists with card grid, search, and empty state
4. NavMenu has Recipes link
5. recipe-placeholder.svg exists in wwwroot/images/
</verification>

<success_criteria>
- Recipe list displays in 3-column grid on desktop, responsive on mobile
- Cards show image, name, and ingredient preview
- Clicking card expands in place to show full details
- Expanded card shows prep time, cook time, servings, ingredients, instructions
- Expanded card has Edit, Delete, Add to Meal Plan buttons
- Search filters recipes by name with debounce
- Empty state shows friendly message and Add Recipe button
- Delete shows confirmation dialog
- Navigation menu has Recipes link
</success_criteria>

<output>
After completion, create `.planning/phases/02-recipe-management/02-05-SUMMARY.md`
</output>

@using FamilyCoordinationApp.Data.Entities

<div class="meal-plan-grid">
    <!-- Header row: day names + dates -->
    <div class="grid-corner"></div>
    @foreach (var day in WeekDays)
    {
        <div class="day-header @(day == DateOnly.FromDateTime(DateTime.Today) ? "today" : "")">
            <MudText Typo="Typo.subtitle2">@day.DayOfWeek.ToString().Substring(0, 3)</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">@day.ToString("MMM d")</MudText>
        </div>
    }

    <!-- Meal rows: Breakfast, Lunch, Dinner -->
    @foreach (var mealType in new[] { MealType.Breakfast, MealType.Lunch, MealType.Dinner })
    {
        <div class="meal-label">
            <MudText Typo="Typo.caption">@mealType</MudText>
        </div>
        @foreach (var day in WeekDays)
        {
            var entries = GetEntries(day, mealType);
            <MealSlot Date="@day"
                      MealType="@mealType"
                      Entries="@entries"
                      OnAddClick="@(() => OnSlotClick.InvokeAsync((day, mealType)))"
                      OnRemoveEntry="@OnRemoveEntry"
                      OnViewRecipe="@OnViewRecipe" />
        }
    }
</div>

@code {
    [Parameter]
    public DateOnly WeekStartDate { get; set; }

    [Parameter]
    public List<MealPlanEntry> Entries { get; set; } = new();

    [Parameter]
    public EventCallback<(DateOnly Date, MealType MealType)> OnSlotClick { get; set; }

    [Parameter]
    public EventCallback<MealPlanEntry> OnRemoveEntry { get; set; }

    [Parameter]
    public EventCallback<Recipe> OnViewRecipe { get; set; }

    private DateOnly[] WeekDays => Enumerable.Range(0, 7)
        .Select(i => WeekStartDate.AddDays(i))
        .ToArray();

    private List<MealPlanEntry> GetEntries(DateOnly date, MealType mealType)
    {
        return Entries?.Where(e => e.Date == date && e.MealType == mealType).ToList() ?? new();
    }
}

<style>
    .meal-plan-grid {
        display: grid;
        grid-template-columns: 60px repeat(7, minmax(0, 1fr));
        gap: 4px;
        width: 100%;
    }

    .grid-corner {
        /* Empty top-left corner */
    }

    .day-header {
        text-align: center;
        padding: 8px 4px;
        min-width: 0;
    }

    .day-header.today {
        background-color: var(--mud-palette-primary);
        border-radius: 4px;
    }

    .meal-label {
        display: flex;
        align-items: center;
        justify-content: center;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
    }

    /* Ensure slots don't overflow and have consistent width */
    .meal-plan-grid > :not(.grid-corner):not(.meal-label):not(.day-header) {
        min-width: 0;
        overflow: hidden;
    }
</style>

name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest code
        run: |
          cd ~/familyapp
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          echo "üì• Pulled commit: $(git rev-parse --short HEAD)"
          
      - name: Build Docker image
        run: |
          cd ~/familyapp
          docker build -t familyapp:latest .
          echo "üê≥ Built image: familyapp:latest"
          
      - name: Deploy containers
        run: |
          cd ~/familyapp
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          echo "üöÄ Containers started"
            
      - name: Health check
        run: |
          echo "‚è≥ Waiting for health check..."
          for i in {1..30}; do
            STATUS=$(docker inspect familyapp-app --format='{{.State.Health.Status}}' 2>/dev/null || echo "starting")
            if [ "$STATUS" = "healthy" ]; then
              echo "‚úÖ App is healthy!"
              exit 0
            fi
            echo "   Status: $STATUS ($i/30)"
            sleep 2
          done
          echo "‚ùå Health check timeout"
          docker logs familyapp-app --tail 50
          exit 1
          
      - name: Cleanup old images
        run: |
          docker image prune -f --filter "until=24h"
          echo "üßπ Cleaned up old images"

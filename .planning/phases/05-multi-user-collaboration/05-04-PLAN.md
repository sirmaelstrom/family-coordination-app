---
phase: 05-multi-user-collaboration
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - src/FamilyCoordinationApp/Components/Shared/UserAvatar.razor
  - src/FamilyCoordinationApp/Components/Shared/UserAvatar.razor.css
  - src/FamilyCoordinationApp/Components/Shared/PresenceBadge.razor
autonomous: true

must_haves:
  truths:
    - "UserAvatar displays Google profile picture or initials fallback"
    - "UserAvatar shows presence badge when enabled"
    - "Avatar uses referrerpolicy='no-referrer' for Google images"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Shared/UserAvatar.razor"
      provides: "Reusable avatar component with presence indicator"
      contains: "PictureUrl"
    - path: "src/FamilyCoordinationApp/Components/Shared/PresenceBadge.razor"
      provides: "Online/away/offline indicator dot"
      contains: "PresenceStatus"
  key_links:
    - from: "UserAvatar.razor"
      to: "MudAvatar"
      via: "Wraps MudAvatar with presence overlay"
      pattern: "<MudAvatar"
---

<objective>
Create reusable UserAvatar component that displays user profile picture with optional presence indicator.

Purpose: Provide consistent avatar display across all attribution locations in the app.
Output: UserAvatar and PresenceBadge components.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-user-collaboration/05-RESEARCH.md
@.planning/phases/05-multi-user-collaboration/05-01-SUMMARY.md
@.planning/phases/05-multi-user-collaboration/05-02-SUMMARY.md
@.planning/phases/05-multi-user-collaboration/05-03-SUMMARY.md
@src/FamilyCoordinationApp/Data/Entities/User.cs
@src/FamilyCoordinationApp/Services/PresenceService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PresenceBadge component</name>
  <files>src/FamilyCoordinationApp/Components/Shared/PresenceBadge.razor</files>
  <action>
Create a small component that displays the colored presence dot:

```razor
@using FamilyCoordinationApp.Services

<div class="presence-badge @GetStatusClass()"></div>

@code {
    [Parameter]
    public PresenceStatus Status { get; set; } = PresenceStatus.Offline;

    private string GetStatusClass() => Status switch
    {
        PresenceStatus.Online => "presence-online",
        PresenceStatus.Away => "presence-away",
        _ => "presence-offline"
    };
}

<style>
    .presence-badge {
        width: 12px;
        height: 12px;
        border: 2px solid var(--mud-palette-surface);
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        right: 0;
    }

    .presence-online {
        background-color: #4caf50;
    }

    .presence-away {
        background-color: #ff9800;
    }

    .presence-offline {
        background-color: #9e9e9e;
    }
</style>
```
  </action>
  <verify>Component compiles, shows colored dot based on status</verify>
  <done>PresenceBadge displays online/away/offline indicator</done>
</task>

<task type="auto">
  <name>Task 2: Create UserAvatar component</name>
  <files>src/FamilyCoordinationApp/Components/Shared/UserAvatar.razor</files>
  <action>
Create the main avatar component:

```razor
@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Services

<div class="user-avatar-container @SizeClass">
    @if (!string.IsNullOrEmpty(PictureUrl))
    {
        <MudAvatar Image="@PictureUrl"
                   Alt="@DisplayName"
                   Size="@Size"
                   Class="user-avatar-img"
                   Style="@($"--img-referrerpolicy: no-referrer")" />
        @* Note: MudBlazor may not support referrerpolicy directly, using img fallback below *@
    }
    else if (!string.IsNullOrEmpty(Initials))
    {
        <MudAvatar Color="@AvatarColor" Size="@Size">
            @Initials
        </MudAvatar>
    }
    else
    {
        <MudAvatar Color="Color.Default" Size="@Size">
            <MudIcon Icon="@Icons.Material.Filled.Person" />
        </MudAvatar>
    }

    @if (ShowPresence)
    {
        <PresenceBadge Status="@PresenceStatus" />
    }
</div>

@* Fallback for Google images with proper referrerpolicy *@
@if (!string.IsNullOrEmpty(PictureUrl))
{
    <style>
        .user-avatar-container .mud-avatar img {
            referrerpolicy: no-referrer;
        }
    </style>
}

@code {
    /// <summary>
    /// User to display avatar for. If provided, extracts PictureUrl, Initials, and DisplayName.
    /// </summary>
    [Parameter]
    public User? User { get; set; }

    /// <summary>
    /// Direct picture URL (used if User not provided)
    /// </summary>
    [Parameter]
    public string? PictureUrl { get; set; }

    /// <summary>
    /// Direct initials (used if User not provided and no PictureUrl)
    /// </summary>
    [Parameter]
    public string? Initials { get; set; }

    /// <summary>
    /// Display name for alt text
    /// </summary>
    [Parameter]
    public string? DisplayName { get; set; }

    /// <summary>
    /// Size of the avatar
    /// </summary>
    [Parameter]
    public Size Size { get; set; } = Size.Medium;

    /// <summary>
    /// Whether to show presence indicator
    /// </summary>
    [Parameter]
    public bool ShowPresence { get; set; }

    /// <summary>
    /// Presence status (only used if ShowPresence is true)
    /// </summary>
    [Parameter]
    public PresenceStatus PresenceStatus { get; set; } = PresenceStatus.Offline;

    /// <summary>
    /// Color for initials avatar
    /// </summary>
    [Parameter]
    public Color AvatarColor { get; set; } = Color.Primary;

    private string SizeClass => Size switch
    {
        Size.Small => "avatar-small",
        Size.Large => "avatar-large",
        _ => "avatar-medium"
    };

    protected override void OnParametersSet()
    {
        // If User is provided, extract properties
        if (User != null)
        {
            PictureUrl ??= User.PictureUrl;
            Initials ??= User.Initials;
            DisplayName ??= User.DisplayName;
        }
    }
}
```
  </action>
  <verify>Component compiles, accepts User or individual properties</verify>
  <done>UserAvatar displays picture or initials with optional presence</done>
</task>

<task type="auto">
  <name>Task 3: Create UserAvatar CSS isolation file</name>
  <files>src/FamilyCoordinationApp/Components/Shared/UserAvatar.razor.css</files>
  <action>
Create scoped CSS for the avatar container:

```css
.user-avatar-container {
    position: relative;
    display: inline-block;
}

/* Size variations for presence badge positioning */
.avatar-small ::deep .presence-badge {
    width: 8px;
    height: 8px;
    border-width: 1px;
}

.avatar-large ::deep .presence-badge {
    width: 14px;
    height: 14px;
    border-width: 2px;
}

/* Ensure Google profile images load with no-referrer policy */
.user-avatar-container ::deep img {
    /* CSS cannot set referrerpolicy, handled in HTML */
}
```
  </action>
  <verify>CSS file exists alongside razor component</verify>
  <done>CSS isolation styles applied to UserAvatar</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. PresenceBadge.razor exists with PresenceStatus parameter
3. UserAvatar.razor exists with User, PictureUrl, Initials, ShowPresence parameters
4. UserAvatar.razor.css exists with scoped styles
</verification>

<success_criteria>
- UserAvatar component accepts User entity or individual properties
- Avatar displays picture when available, initials fallback otherwise
- PresenceBadge shows correct color for online/away/offline
- Components compile and render without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-user-collaboration/05-04-SUMMARY.md`
</output>

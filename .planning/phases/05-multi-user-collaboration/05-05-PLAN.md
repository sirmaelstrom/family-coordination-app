---
phase: 05-multi-user-collaboration
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/FamilyCoordinationApp/Components/Layout/MainLayout.razor
  - src/FamilyCoordinationApp/Components/Shared/SyncStatus.razor
  - src/FamilyCoordinationApp/Components/Shared/OnlineUsers.razor
autonomous: true

must_haves:
  truths:
    - "MainLayout shows sync status indicator (connected/syncing/error)"
    - "MainLayout displays online family members in header"
    - "Component sends heartbeat to PresenceService on init and periodically"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Layout/MainLayout.razor"
      provides: "Header with presence and sync indicators"
      contains: "SyncStatus"
    - path: "src/FamilyCoordinationApp/Components/Shared/SyncStatus.razor"
      provides: "Sync status indicator component"
      contains: "DataNotifier"
    - path: "src/FamilyCoordinationApp/Components/Shared/OnlineUsers.razor"
      provides: "Online family members display"
      contains: "PresenceService"
  key_links:
    - from: "MainLayout"
      to: "PresenceService.Heartbeat"
      via: "Timer-based heartbeat on page load"
      pattern: "presenceService\\.Heartbeat"
---

<objective>
Add collaboration UI to MainLayout: sync status indicator, online family members display, and heartbeat integration.

Purpose: Users see who's online and whether data is syncing without intrusive notifications.
Output: MainLayout enhanced with presence/sync indicators.
</objective>

<execution_context>
@/home/[USER]/.claude/get-shit-done/workflows/execute-plan.md
@/home/[USER]/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-user-collaboration/05-RESEARCH.md
@.planning/phases/05-multi-user-collaboration/05-03-SUMMARY.md
@.planning/phases/05-multi-user-collaboration/05-04-SUMMARY.md
@src/FamilyCoordinationApp/Components/Layout/MainLayout.razor
@src/FamilyCoordinationApp/Services/PresenceService.cs
@src/FamilyCoordinationApp/Services/DataNotifier.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncStatus indicator component</name>
  <files>src/FamilyCoordinationApp/Components/Shared/SyncStatus.razor</files>
  <action>
Create a small sync status indicator that shows connection state:

```razor
@using FamilyCoordinationApp.Services
@implements IDisposable

@inject DataNotifier Notifier

<MudTooltip Text="@StatusText" Placement="Placement.Bottom">
    <div class="sync-status @StatusClass">
        @if (_isSyncing)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" Style="width: 16px; height: 16px;" />
        }
        else
        {
            <MudIcon Icon="@StatusIcon" Size="Size.Small" Color="@StatusColor" />
        }
    </div>
</MudTooltip>

@code {
    private bool _isSyncing;
    private DateTime _lastSync = DateTime.UtcNow;
    private bool _hasError;

    private string StatusText => _hasError
        ? "Sync error - will retry"
        : _isSyncing
            ? "Syncing..."
            : $"Synced {GetTimeSinceLastSync()}";

    private string StatusClass => _hasError ? "sync-error" : "sync-ok";

    private string StatusIcon => _hasError
        ? Icons.Material.Filled.CloudOff
        : Icons.Material.Filled.CloudDone;

    private Color StatusColor => _hasError ? Color.Error : Color.Success;

    protected override void OnInitialized()
    {
        Notifier.OnShoppingListChanged += OnDataSynced;
        Notifier.OnRecipesChanged += OnDataSynced;
        Notifier.OnMealPlanChanged += OnDataSynced;
    }

    private void OnDataSynced()
    {
        InvokeAsync(() =>
        {
            _lastSync = DateTime.UtcNow;
            _isSyncing = false;
            _hasError = false;
            StateHasChanged();
        });
    }

    private string GetTimeSinceLastSync()
    {
        var elapsed = DateTime.UtcNow - _lastSync;
        return elapsed.TotalSeconds < 10 ? "just now"
            : elapsed.TotalMinutes < 1 ? $"{(int)elapsed.TotalSeconds}s ago"
            : elapsed.TotalMinutes < 60 ? $"{(int)elapsed.TotalMinutes}m ago"
            : "a while ago";
    }

    public void Dispose()
    {
        Notifier.OnShoppingListChanged -= OnDataSynced;
        Notifier.OnRecipesChanged -= OnDataSynced;
        Notifier.OnMealPlanChanged -= OnDataSynced;
    }
}

<style>
    .sync-status {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
    }
</style>
```
  </action>
  <verify>Component compiles, subscribes to DataNotifier events</verify>
  <done>SyncStatus shows connection state with tooltip</done>
</task>

<task type="auto">
  <name>Task 2: Create OnlineUsers display component</name>
  <files>src/FamilyCoordinationApp/Components/Shared/OnlineUsers.razor</files>
  <action>
Create component showing online family members:

```razor
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Shared
@implements IDisposable

@inject PresenceService PresenceService

@if (_onlineUsers.Any())
{
    <div class="online-users d-flex align-center gap-1">
        <MudTooltip Text="@GetTooltipText()" Placement="Placement.Bottom">
            <div class="d-flex">
                @foreach (var user in _onlineUsers.Take(3))
                {
                    <div class="online-user-avatar" style="margin-left: -8px;">
                        <UserAvatar PictureUrl="@user.PictureUrl"
                                    Initials="@user.Initials"
                                    DisplayName="@user.DisplayName"
                                    Size="Size.Small"
                                    ShowPresence="true"
                                    PresenceStatus="@user.Status" />
                    </div>
                }
                @if (_onlineUsers.Count > 3)
                {
                    <MudAvatar Size="Size.Small" Color="Color.Secondary" Style="margin-left: -8px;">
                        +@(_onlineUsers.Count - 3)
                    </MudAvatar>
                }
            </div>
        </MudTooltip>
    </div>
}

@code {
    /// <summary>
    /// Current user ID to exclude from display
    /// </summary>
    [Parameter]
    public int CurrentUserId { get; set; }

    private List<UserPresence> _onlineUsers = new();

    protected override void OnInitialized()
    {
        PresenceService.OnPresenceChanged += OnPresenceChanged;
        LoadOnlineUsers();
    }

    private void OnPresenceChanged()
    {
        InvokeAsync(() =>
        {
            LoadOnlineUsers();
            StateHasChanged();
        });
    }

    private void LoadOnlineUsers()
    {
        _onlineUsers = PresenceService.GetAllActiveUsers()
            .Where(u => u.UserId != CurrentUserId)
            .OrderByDescending(u => u.Status == PresenceStatus.Online)
            .ThenBy(u => u.DisplayName)
            .ToList();
    }

    private string GetTooltipText()
    {
        if (!_onlineUsers.Any())
            return "No other family members online";

        var online = _onlineUsers.Where(u => u.Status == PresenceStatus.Online).Select(u => u.DisplayName);
        var away = _onlineUsers.Where(u => u.Status == PresenceStatus.Away).Select(u => u.DisplayName);

        var parts = new List<string>();
        if (online.Any())
            parts.Add($"Online: {string.Join(", ", online)}");
        if (away.Any())
            parts.Add($"Away: {string.Join(", ", away)}");

        return string.Join("\n", parts);
    }

    public void Dispose()
    {
        PresenceService.OnPresenceChanged -= OnPresenceChanged;
    }
}

<style>
    .online-users {
        padding: 4px 8px;
    }

    .online-user-avatar:first-child {
        margin-left: 0 !important;
    }
</style>
```
  </action>
  <verify>Component compiles, shows avatars for online users</verify>
  <done>OnlineUsers displays family members currently online</done>
</task>

<task type="auto">
  <name>Task 3: Integrate presence and sync into MainLayout</name>
  <files>src/FamilyCoordinationApp/Components/Layout/MainLayout.razor</files>
  <action>
Update MainLayout to include presence heartbeat and display components:

1. Add using statements and inject services:
```razor
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Shared
@using FamilyCoordinationApp.Data
@using Microsoft.EntityFrameworkCore
@implements IDisposable

@inject PresenceService PresenceService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
```

2. Modify the top-row section in the Authorized block to include OnlineUsers and SyncStatus:
```razor
<AuthorizeView>
    <Authorized>
        <div class="d-flex align-center gap-4">
            <OnlineUsers CurrentUserId="@_currentUserId" />
            <SyncStatus />
            <MudText Typo="Typo.body2" Color="Color.Secondary">@context.User.Identity?.Name</MudText>
            <MudLink Href="/account/logout" Typo="Typo.body2">Sign out</MudLink>
        </div>
    </Authorized>
</AuthorizeView>
```

3. Add heartbeat logic in @code block:
```csharp
private int _currentUserId;
private string? _currentUserPicture;
private string _currentUserInitials = string.Empty;
private string _currentUserName = string.Empty;
private System.Timers.Timer? _heartbeatTimer;

protected override async Task OnInitializedAsync()
{
    await LoadCurrentUser();
    StartHeartbeat();
    NavigationManager.LocationChanged += OnLocationChanged;
}

private async Task LoadCurrentUser()
{
    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

    if (email != null)
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
        if (user != null)
        {
            _currentUserId = user.Id;
            _currentUserPicture = user.PictureUrl;
            _currentUserInitials = user.Initials;
            _currentUserName = user.DisplayName;
            SendHeartbeat();
        }
    }
}

private void StartHeartbeat()
{
    // Send heartbeat every 30 seconds
    _heartbeatTimer = new System.Timers.Timer(30000);
    _heartbeatTimer.Elapsed += (_, _) => SendHeartbeat();
    _heartbeatTimer.AutoReset = true;
    _heartbeatTimer.Start();
}

private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
{
    SendHeartbeat();
}

private void SendHeartbeat()
{
    if (_currentUserId > 0)
    {
        var currentPage = new Uri(NavigationManager.Uri).AbsolutePath;
        PresenceService.Heartbeat(_currentUserId, _currentUserName, _currentUserPicture, _currentUserInitials, currentPage);
    }
}

public void Dispose()
{
    NavigationManager.LocationChanged -= OnLocationChanged;
    _heartbeatTimer?.Stop();
    _heartbeatTimer?.Dispose();
    if (_currentUserId > 0)
    {
        PresenceService.UserDisconnected(_currentUserId);
    }
}
```

Note: Keep the existing _isDarkMode and _theme code in the @code block.
  </action>
  <verify>MainLayout compiles, shows OnlineUsers and SyncStatus in header, sends heartbeat</verify>
  <done>MainLayout displays presence/sync indicators and maintains heartbeat</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. SyncStatus.razor exists with DataNotifier subscription
3. OnlineUsers.razor exists with PresenceService integration
4. MainLayout.razor includes OnlineUsers, SyncStatus, and heartbeat logic
5. MainLayout implements IDisposable and cleans up timer/events
</verification>

<success_criteria>
- SyncStatus shows connection indicator with last sync time
- OnlineUsers displays other family members with presence status
- MainLayout sends heartbeat every 30 seconds and on navigation
- All components properly dispose event subscriptions
- Solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-user-collaboration/05-05-SUMMARY.md`
</output>

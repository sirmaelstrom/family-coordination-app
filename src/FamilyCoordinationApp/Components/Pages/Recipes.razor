@page "/recipes"
@rendermode InteractiveServer
@attribute [Authorize]
@implements IDisposable
@using System.Security.Claims
@using FamilyCoordinationApp.Data
@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.Recipe
@using FamilyCoordinationApp.Components.Shared
@using Microsoft.EntityFrameworkCore
@using Markdig
@inject IRecipeService RecipeService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject DataNotifier Notifier
@inject IDialogService DialogService

<PageTitle>Recipes - Family Coordination</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <div class="d-flex justify-space-between align-center flex-wrap mb-4 gap-3">
        <MudText Typo="Typo.h4">Recipes</MudText>
        <div class="d-flex gap-2 flex-wrap">
            <MudHidden Breakpoint="Breakpoint.Xs">
                <MudButton StartIcon="@Icons.Material.Filled.CloudDownload"
                           Color="Color.Secondary"
                           Variant="Variant.Outlined"
                           OnClick="OpenImportDialog">
                    Import from URL
                </MudButton>
            </MudHidden>
            <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">
                <MudIconButton Icon="@Icons.Material.Filled.CloudDownload"
                               Color="Color.Secondary"
                               OnClick="OpenImportDialog"
                               aria-label="Import from URL" />
            </MudHidden>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="HandleAddRecipe">
                <MudHidden Breakpoint="Breakpoint.Xs">Add Recipe</MudHidden>
                <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">Add</MudHidden>
            </MudButton>
        </div>
    </div>

    <MudTextField @bind-Value="_searchTerm"
                  Label="Search recipes"
                  Variant="Variant.Outlined"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="LoadRecipes"
                  Class="mb-4" />

    @if (_loading)
    {
        <!-- Loading skeleton -->
        <MudGrid>
            @for (int i = 0; i < 6; i++)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
                        <MudCardContent>
                            <MudSkeleton SkeletonType="SkeletonType.Text" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_recipes.Any())
    {
        <!-- Empty state -->
        <div class="d-flex flex-column align-center justify-center" style="min-height: 400px;">
            <MudIcon Icon="@Icons.Material.Filled.MenuBook"
                     Size="Size.Large"
                     Color="Color.Secondary"
                     Style="font-size: 6rem; margin-bottom: 1rem;" />
            <MudText Typo="Typo.h5" Class="mb-2">No recipes yet</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                @if (string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <text>Start building your family recipe collection</text>
                }
                else
                {
                    <text>No recipes found matching "@_searchTerm"</text>
                }
            </MudText>
            @if (string.IsNullOrWhiteSpace(_searchTerm))
            {
                <MudButton StartIcon="@Icons.Material.Filled.Add"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           Size="Size.Large"
                           OnClick="HandleAddRecipe">
                    Add Your First Recipe
                </MudButton>
            }
            else
            {
                <MudButton StartIcon="@Icons.Material.Filled.Clear"
                           Color="Color.Primary"
                           Variant="Variant.Text"
                           OnClick="ClearSearch">
                    Clear Search
                </MudButton>
            }
        </div>
    }
    else
    {
        <!-- Recipe grid -->
        <MudGrid>
            @foreach (var recipe in _recipes)
            {
                <MudItem xs="12" sm="6" md="4">
                    <RecipeCard Recipe="recipe"
                                IsSelected="@(_selectedRecipe?.RecipeId == recipe.RecipeId)"
                                OnClick="HandleCardClick" />
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<!-- Overlay for dimming when drawer is open -->
@if (_drawerOpen)
{
    <div class="recipe-drawer-overlay" @onclick="CloseDrawer"></div>
}

<!-- Recipe detail slide-out panel -->
<MudDrawer @bind-Open="_drawerOpen"
           Anchor="Anchor.End"
           Elevation="4"
           Variant="DrawerVariant.Temporary"
           Width="min(800px, 90vw)"
           Class="recipe-detail-drawer">
    @if (_selectedRecipe != null)
    {
        <MudDrawerHeader Class="recipe-drawer-header">
            <div class="d-flex justify-space-between align-center" style="width: 100%;">
                <MudText Typo="Typo.h5" Class="text-truncate" Style="max-width: calc(100% - 48px);">
                    @_selectedRecipe.Name
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               OnClick="CloseDrawer"
                               aria-label="Close panel" />
            </div>
        </MudDrawerHeader>

        <div class="recipe-drawer-content">
            <!-- Recipe Image -->
            @if (!string.IsNullOrWhiteSpace(_selectedRecipe.ImagePath))
            {
                <div class="recipe-detail-image">
                    <img src="@_selectedRecipe.ImagePath" alt="@_selectedRecipe.Name" />
                </div>
            }

            <!-- Author info -->
            <div class="d-flex align-center gap-2 mb-3">
                @if (_selectedRecipe.CreatedBy != null)
                {
                    <UserAvatar User="@_selectedRecipe.CreatedBy" Size="Size.Small" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Added by @_selectedRecipe.CreatedBy.DisplayName
                    </MudText>
                }
                else
                {
                    <MudAvatar Size="Size.Small" Color="Color.Default">
                        <MudIcon Icon="@Icons.Material.Filled.PersonOff" Size="Size.Small" />
                    </MudAvatar>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">
                        Added by deleted user
                    </MudText>
                }
            </div>

            <!-- Meta chips -->
            @if (_selectedRecipe.PrepTimeMinutes.HasValue || _selectedRecipe.CookTimeMinutes.HasValue || _selectedRecipe.Servings.HasValue)
            {
                <div class="recipe-meta-chips mb-4">
                    @if (_selectedRecipe.PrepTimeMinutes.HasValue)
                    {
                        <MudChip T="string" Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Info">
                            Prep: @_selectedRecipe.PrepTimeMinutes min
                        </MudChip>
                    }
                    @if (_selectedRecipe.CookTimeMinutes.HasValue)
                    {
                        <MudChip T="string" Icon="@Icons.Material.Filled.Whatshot" Size="Size.Small" Color="Color.Warning">
                            Cook: @_selectedRecipe.CookTimeMinutes min
                        </MudChip>
                    }
                    @if (_selectedRecipe.Servings.HasValue)
                    {
                        <MudChip T="string" Icon="@Icons.Material.Filled.Restaurant" Size="Size.Small" Color="Color.Success">
                            Servings: @_selectedRecipe.Servings
                        </MudChip>
                    }
                </div>
            }

            <!-- Description -->
            @if (!string.IsNullOrWhiteSpace(_selectedRecipe.Description))
            {
                <MudText Typo="Typo.body1" Class="mb-4">@_selectedRecipe.Description</MudText>
            }

            <!-- Ingredients -->
            @if (_selectedRecipe.Ingredients.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-2">Ingredients</MudText>
                <MudList T="string" Dense="true" Class="mb-4">
                    @foreach (var ingredient in _selectedRecipe.Ingredients.OrderBy(i => i.SortOrder))
                    {
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                            @GetIngredientDisplay(ingredient)
                        </MudListItem>
                    }
                </MudList>
            }

            <!-- Instructions -->
            @if (!string.IsNullOrWhiteSpace(_selectedRecipe.Instructions))
            {
                <MudText Typo="Typo.h6" Class="mb-2">Instructions</MudText>
                <div class="recipe-instructions mb-4">
                    @((MarkupString)Markdown.ToHtml(_selectedRecipe.Instructions))
                </div>
            }

            <!-- Source URL -->
            @if (!string.IsNullOrWhiteSpace(_selectedRecipe.SourceUrl))
            {
                <div class="d-flex align-center mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="mr-2" />
                    <a href="@_selectedRecipe.SourceUrl"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="mud-typography mud-link mud-secondary-text mud-typography-body2">
                        View Original Recipe
                    </a>
                </div>
            }
        </div>

        <!-- Action buttons -->
        <div class="recipe-drawer-actions">
            <MudButton StartIcon="@Icons.Material.Filled.Edit"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="@(() => HandleEdit(_selectedRecipe))"
                       FullWidth="true"
                       Class="mb-2">
                Edit Recipe
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.CalendarMonth"
                       Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       OnClick="@(() => HandleAddToMealPlan(_selectedRecipe))"
                       FullWidth="true"
                       Class="mb-2">
                Add to Meal Plan
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.Delete"
                       Color="Color.Error"
                       Variant="Variant.Text"
                       OnClick="@(() => HandleDeleteConfirm(_selectedRecipe))"
                       FullWidth="true">
                Delete Recipe
            </MudButton>
        </div>
    }
</MudDrawer>

<!-- Delete confirmation dialog -->
<MudDialog @bind-Visible="_showDeleteDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Delete Recipe</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            Are you sure you want to delete "<strong>@_recipeToDelete?.Name</strong>"?
            This action cannot be undone.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelDelete" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="ConfirmDelete" Color="Color.Error" Variant="Variant.Filled">Delete</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .recipe-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1299; /* Just below MudDrawer's z-index */
    }

    .recipe-detail-drawer {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .recipe-drawer-header {
        flex-shrink: 0;
        border-bottom: 1px solid var(--mud-palette-lines-default);
    }

    .recipe-drawer-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
    }

    .recipe-detail-image {
        width: 100%;
        height: 250px;
        margin-bottom: 16px;
        border-radius: 8px;
        overflow: hidden;
    }

    .recipe-detail-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .recipe-meta-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .recipe-instructions {
        line-height: 1.6;
    }

    .recipe-instructions ol,
    .recipe-instructions ul {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }

    .recipe-instructions li {
        margin-bottom: 0.5rem;
    }

    .recipe-drawer-actions {
        flex-shrink: 0;
        padding: 16px 24px;
        border-top: 1px solid var(--mud-palette-lines-default);
        background: var(--mud-palette-background);
    }
</style>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthState { get; set; }

    private List<Recipe> _recipes = new();
    private bool _loading = true;
    private string _searchTerm = string.Empty;
    private int _householdId;

    private Recipe? _selectedRecipe;
    private bool _drawerOpen;

    private bool _showDeleteDialog;
    private Recipe? _recipeToDelete;

    private DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small
    };

    protected override async Task OnInitializedAsync()
    {
        Notifier.OnRecipesChanged += OnDataChanged;

        await LoadUserContext();
        if (_householdId > 0)
        {
            await LoadRecipes();
        }
        else
        {
            Snackbar.Add("Unable to load household information", Severity.Error);
            _loading = false;
        }
    }

    private async Task LoadUserContext()
    {
        if (AuthState == null) return;

        var authState = await AuthState;
        var email = authState.User.FindFirstValue(ClaimTypes.Email);

        if (string.IsNullOrEmpty(email)) return;

        await using var context = await DbFactory.CreateDbContextAsync();
        var user = await context.Users
            .FirstOrDefaultAsync(u => u.Email == email);

        if (user != null)
        {
            _householdId = user.HouseholdId;
        }
    }

    private async Task LoadRecipes()
    {
        try
        {
            _loading = true;
            _recipes = await RecipeService.GetRecipesAsync(_householdId, _searchTerm);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading recipes: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void HandleCardClick(Recipe recipe)
    {
        _selectedRecipe = recipe;
        _drawerOpen = true;
    }

    private void CloseDrawer()
    {
        _drawerOpen = false;
        // Keep _selectedRecipe so the drawer content doesn't flash during close animation
    }

    private void HandleAddRecipe()
    {
        NavigationManager.NavigateTo("/recipes/new");
    }

    private async Task OpenImportDialog()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ImportRecipeDialog>("Import Recipe", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // Refresh recipe list after successful import
            await LoadRecipes();
        }
    }

    private void HandleEdit(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/edit/{recipe.RecipeId}");
    }

    private void HandleDeleteConfirm(Recipe recipe)
    {
        _recipeToDelete = recipe;
        _showDeleteDialog = true;
    }

    private void CancelDelete()
    {
        _showDeleteDialog = false;
        _recipeToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (_recipeToDelete == null) return;

        try
        {
            await RecipeService.DeleteRecipeAsync(_householdId, _recipeToDelete.RecipeId);
            Snackbar.Add($"Recipe '{_recipeToDelete.Name}' deleted", Severity.Success);

            // Close drawer if this was the selected recipe
            if (_selectedRecipe?.RecipeId == _recipeToDelete.RecipeId)
            {
                _drawerOpen = false;
                _selectedRecipe = null;
            }

            // Reload recipes
            await LoadRecipes();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting recipe: {ex.Message}", Severity.Error);
        }
        finally
        {
            _showDeleteDialog = false;
            _recipeToDelete = null;
        }
    }

    private void HandleAddToMealPlan(Recipe recipe)
    {
        // TODO: Navigate to meal plan with this recipe (Phase 3)
        Snackbar.Add($"Add '{recipe.Name}' to meal plan - coming soon", Severity.Info);
    }

    private async Task ClearSearch()
    {
        _searchTerm = string.Empty;
        await LoadRecipes();
    }

    private string GetIngredientDisplay(RecipeIngredient ingredient)
    {
        var parts = new List<string>();

        if (ingredient.Quantity.HasValue)
        {
            parts.Add(ingredient.Quantity.Value.ToString("0.##"));
        }

        if (!string.IsNullOrWhiteSpace(ingredient.Unit))
        {
            parts.Add(ingredient.Unit);
        }

        parts.Add(ingredient.Name);

        if (!string.IsNullOrWhiteSpace(ingredient.Notes))
        {
            parts.Add($"({ingredient.Notes})");
        }

        return string.Join(" ", parts);
    }

    private void OnDataChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadRecipes();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Notifier.OnRecipesChanged -= OnDataChanged;
    }
}

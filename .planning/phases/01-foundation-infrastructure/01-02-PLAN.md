---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/FamilyCoordinationApp/Program.cs
  - src/FamilyCoordinationApp/appsettings.json
  - src/FamilyCoordinationApp/appsettings.Development.json
  - src/FamilyCoordinationApp/Authorization/WhitelistedEmailRequirement.cs
  - src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs
  - src/FamilyCoordinationApp/Components/Pages/Account/Login.razor
  - src/FamilyCoordinationApp/Components/Pages/Account/Logout.razor
  - src/FamilyCoordinationApp/Components/Pages/Account/AccessDenied.razor
  - src/FamilyCoordinationApp/Components/Layout/MainLayout.razor
  - src/FamilyCoordinationApp/Components/_Imports.razor
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth authentication for family login"
    env_vars:
      - name: Authentication__Google__ClientId
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: Authentication__Google__ClientSecret
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials"
      - task: "Add authorized redirect URI: https://localhost:7xxx/signin-google (dev)"
        location: "OAuth client configuration"
      - task: "Add authorized redirect URI: https://family.example.com/signin-google (prod)"
        location: "OAuth client configuration"

must_haves:
  truths:
    - "User can click Sign In and authenticate with Google OAuth"
    - "User email is validated against whitelist after Google auth succeeds"
    - "Non-whitelisted users see friendly access denied message"
    - "User session persists across browser restarts (persistent cookie)"
    - "User can log out from any page and be redirected to login"
  artifacts:
    - path: "src/FamilyCoordinationApp/Authorization/WhitelistedEmailRequirement.cs"
      provides: "Custom authorization requirement for whitelist check"
      contains: "IAuthorizationRequirement"
    - path: "src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs"
      provides: "Handler that validates email against User table"
      contains: "AuthorizationHandler"
    - path: "src/FamilyCoordinationApp/Components/Pages/Account/Login.razor"
      provides: "Login page with Google OAuth button"
      contains: "Challenge"
    - path: "src/FamilyCoordinationApp/Components/Pages/Account/Logout.razor"
      provides: "Logout handler that signs out user"
      contains: "SignOutAsync"
  key_links:
    - from: "Program.cs"
      to: "Google OAuth"
      via: "AddGoogle authentication configuration"
      pattern: "AddGoogle"
    - from: "WhitelistedEmailHandler.cs"
      to: "ApplicationDbContext"
      via: "DbContextFactory to check User table"
      pattern: "DbContextFactory.*ApplicationDbContext"
    - from: "Program.cs"
      to: "WhitelistedEmailRequirement"
      via: "FallbackPolicy with requirement"
      pattern: "FallbackPolicy.*WhitelistedEmailRequirement"
    - from: "Login.razor"
      to: "Program.cs auth endpoints"
      via: "Form POST to /account/login-google"
      pattern: "MapPost.*login-google"
---

<objective>
Implement Google OAuth authentication with email whitelist authorization.

Purpose: Only whitelisted family members can access the app. Google OAuth simplifies login (no passwords to manage), and the whitelist provides access control. Session persistence means users don't re-authenticate on every visit.

Output: Working authentication flow where users sign in with Google, are validated against the User table whitelist, and can log out from any page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Google OAuth authentication in Program.cs</name>
  <files>
    src/FamilyCoordinationApp/Program.cs
    src/FamilyCoordinationApp/appsettings.json
    src/FamilyCoordinationApp/appsettings.Development.json
  </files>
  <action>
Add Google OAuth authentication to Program.cs.

**appsettings.json** (structure only, actual values from environment):
```json
{
  "Authentication": {
    "Google": {
      "ClientId": "",
      "ClientSecret": ""
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": ""
  }
}
```

**Program.cs additions** (after DbContextFactory, before builder.Build()):
```csharp
// Authentication
builder.Services.AddAuthentication(options =>
{
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = GoogleDefaults.AuthenticationScheme;
})
.AddCookie(options =>
{
    options.Cookie.Name = "FamilyApp.Auth";
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.Cookie.SameSite = SameSiteMode.Lax;
    options.ExpireTimeSpan = TimeSpan.FromDays(30);  // Persist session
    options.SlidingExpiration = true;
    options.LoginPath = "/account/login";
    options.LogoutPath = "/account/logout";
    options.AccessDeniedPath = "/account/access-denied";
})
.AddGoogle(options =>
{
    options.ClientId = builder.Configuration["Authentication:Google:ClientId"]
        ?? throw new InvalidOperationException("Google ClientId not configured");
    options.ClientSecret = builder.Configuration["Authentication:Google:ClientSecret"]
        ?? throw new InvalidOperationException("Google ClientSecret not configured");
    options.SaveTokens = false;  // Don't need refresh tokens for this app
});
```

**After app.Build(), configure middleware order** (CRITICAL for reverse proxy):
```csharp
var app = builder.Build();

// Forwarded headers MUST come first (for nginx reverse proxy)
app.UseForwardedHeaders(new ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
});

// Standard middleware order
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseAntiforgery();

// Auth middleware
app.UseAuthentication();
app.UseAuthorization();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

app.Run();
```

Add required usings:
```csharp
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.Google;
using Microsoft.AspNetCore.HttpOverrides;
```

Why 30-day expiry: Per AUTH-03, session must persist across browser restarts. 30 days with sliding expiration means active users stay logged in.
  </action>
  <verify>
```bash
cd /home/[USER]/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
```
Build succeeds. Grep for auth config:
```bash
grep -E "(AddGoogle|AddCookie|AddAuthentication)" Program.cs
```
  </verify>
  <done>Google OAuth configured with persistent cookie (30-day expiry, sliding). Forwarded headers middleware first in pipeline.</done>
</task>

<task type="auto">
  <name>Task 2: Create custom authorization requirement and handler for email whitelist (AUTH-02)</name>
  <files>
    src/FamilyCoordinationApp/Authorization/WhitelistedEmailRequirement.cs
    src/FamilyCoordinationApp/Authorization/WhitelistedEmailHandler.cs
    src/FamilyCoordinationApp/Program.cs
  </files>
  <action>
Create Authorization/ directory with custom authorization components.

**This task implements AUTH-02: "User email is validated against whitelist for family access"**

**WhitelistedEmailRequirement.cs**:
```csharp
using Microsoft.AspNetCore.Authorization;

namespace FamilyCoordinationApp.Authorization;

public class WhitelistedEmailRequirement : IAuthorizationRequirement
{
    // Marker class - no properties needed
}
```

**WhitelistedEmailHandler.cs**:
```csharp
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using FamilyCoordinationApp.Data;

namespace FamilyCoordinationApp.Authorization;

/// <summary>
/// Implements AUTH-02: Validates user email claim against User table whitelist.
/// Only users with IsWhitelisted=true are granted access.
/// </summary>
public class WhitelistedEmailHandler : AuthorizationHandler<WhitelistedEmailRequirement>
{
    private readonly IDbContextFactory<ApplicationDbContext> _dbFactory;
    private readonly ILogger<WhitelistedEmailHandler> _logger;

    public WhitelistedEmailHandler(
        IDbContextFactory<ApplicationDbContext> dbFactory,
        ILogger<WhitelistedEmailHandler> logger)
    {
        _dbFactory = dbFactory;
        _logger = logger;
    }

    protected override async Task HandleRequirementAsync(
        AuthorizationHandlerContext context,
        WhitelistedEmailRequirement requirement)
    {
        // Extract email claim from authenticated user
        var emailClaim = context.User.FindFirst(ClaimTypes.Email);
        if (emailClaim is null)
        {
            _logger.LogWarning("No email claim found in user context");
            return; // Fail authorization silently
        }

        var email = emailClaim.Value;

        try
        {
            // Check database for whitelisted user
            using var dbContext = _dbFactory.CreateDbContext();
            var user = await dbContext.Users
                .FirstOrDefaultAsync(u => u.Email == email && u.IsWhitelisted);

            if (user is not null)
            {
                // Update last login timestamp
                user.LastLoginAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();

                context.Succeed(requirement);
                _logger.LogInformation("User {Email} authorized successfully", email);
            }
            else
            {
                _logger.LogWarning("User {Email} not whitelisted or not found", email);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error checking whitelist for {Email}", email);
            // Fail authorization on error (safe default)
        }
    }
}
```

**Program.cs additions** (after authentication config):
```csharp
// Authorization
builder.Services.AddScoped<IAuthorizationHandler, WhitelistedEmailHandler>();
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("WhitelistedOnly", policy =>
        policy.Requirements.Add(new WhitelistedEmailRequirement()));

    // Apply whitelist check to all authenticated requests
    options.FallbackPolicy = new AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddRequirements(new WhitelistedEmailRequirement())
        .Build();
});
```

Add using:
```csharp
using FamilyCoordinationApp.Authorization;
```

Why Scoped not Singleton: Handler uses DbContextFactory which is fine, but scoped matches typical handler lifetime and allows per-request logging context.
  </action>
  <verify>
```bash
cd /home/[USER]/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
```
Build succeeds. Files exist:
```bash
ls Authorization/*.cs
```
  </verify>
  <done>WhitelistedEmailRequirement and WhitelistedEmailHandler created. FallbackPolicy applies whitelist check to all authenticated requests. AUTH-02 implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Create login, logout, and access denied pages with auth endpoints</name>
  <files>
    src/FamilyCoordinationApp/Components/Pages/Account/Login.razor
    src/FamilyCoordinationApp/Components/Pages/Account/Logout.razor
    src/FamilyCoordinationApp/Components/Pages/Account/AccessDenied.razor
    src/FamilyCoordinationApp/Components/Layout/MainLayout.razor
    src/FamilyCoordinationApp/Components/_Imports.razor
    src/FamilyCoordinationApp/Program.cs
  </files>
  <action>
Create Components/Pages/Account/ directory with auth pages and add minimal API endpoints to Program.cs.

**Login.razor** (triggers Google OAuth challenge):
```razor
@page "/account/login"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Google
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Sign In - Family Coordination</PageTitle>

<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Family Coordination</h1>
            <p class="mt-2 text-gray-600">Meal planning and shopping lists for the family</p>
        </div>

        <div class="mt-8 bg-white py-8 px-4 shadow rounded-lg">
            <form method="post" action="/account/login-google">
                <button type="submit"
                        class="w-full flex justify-center items-center gap-3 py-3 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
            </form>
        </div>

        <p class="text-center text-sm text-gray-500">
            This app is for family members only.
        </p>
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        // If already authenticated, redirect to home
        var user = HttpContextAccessor.HttpContext?.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
    }
}
```

**Add minimal API endpoints to Program.cs** (before app.Run()):
```csharp
// Auth endpoints (minimal API) - wiring for Login.razor form POST
app.MapPost("/account/login-google", async (HttpContext context) =>
{
    var properties = new AuthenticationProperties
    {
        RedirectUri = "/",
        IsPersistent = true  // Remember me
    };
    await context.ChallengeAsync(GoogleDefaults.AuthenticationScheme, properties);
});

app.MapGet("/account/logout", async (HttpContext context) =>
{
    await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    return Results.Redirect("/account/login");
});
```

**Logout.razor** (confirmation page):
```razor
@page "/account/logout"
@attribute [AllowAnonymous]

<PageTitle>Signed Out - Family Coordination</PageTitle>

<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
    <div class="max-w-md w-full text-center space-y-6">
        <h1 class="text-2xl font-bold text-gray-900">You've been signed out</h1>
        <p class="text-gray-600">Thanks for using Family Coordination!</p>
        <a href="/account/login" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Sign in again
        </a>
    </div>
</div>
```

**AccessDenied.razor** (friendly message for non-whitelisted users):
```razor
@page "/account/access-denied"
@attribute [AllowAnonymous]

<PageTitle>Access Denied - Family Coordination</PageTitle>

<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
    <div class="max-w-md w-full text-center space-y-6">
        <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">Access Denied</h1>
        <p class="text-gray-600">
            This app is for family members only. If you should have access, please contact the family administrator to add your email to the whitelist.
        </p>
        <a href="/account/logout" class="inline-block px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700">
            Sign out and try another account
        </a>
    </div>
</div>
```

**Update MainLayout.razor** to show user email and logout button:
Add to the header section:
```razor
@inject AuthenticationStateProvider AuthenticationStateProvider

<AuthorizeView>
    <Authorized>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-600">@context.User.Identity?.Name</span>
            <a href="/account/logout" class="text-sm text-blue-600 hover:underline">Sign out</a>
        </div>
    </Authorized>
</AuthorizeView>
```

**Add using to _Imports.razor**:
```razor
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
```

Why POST for login: OAuth challenge should use POST (CSRF protection). The form posts to minimal API endpoint which initiates the challenge.
  </action>
  <verify>
```bash
cd /home/[USER]/projects/github/family-coordination-app/src/FamilyCoordinationApp
dotnet build
```
Build succeeds. Files exist:
```bash
ls Components/Pages/Account/*.razor
```
Should show Login.razor, Logout.razor, AccessDenied.razor.

Verify auth endpoints in Program.cs:
```bash
grep -E "(login-google|/account/logout)" Program.cs
```
  </verify>
  <done>Login, Logout, and AccessDenied pages created. MainLayout shows user email and logout link. Auth endpoints (MapPost /account/login-google, MapGet /account/logout) configured in Program.cs.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Project builds**:
   ```bash
   cd /home/[USER]/projects/github/family-coordination-app/src/FamilyCoordinationApp
   dotnet build
   ```

2. **Auth configuration present**:
   ```bash
   grep -E "(AddGoogle|AddCookie|FallbackPolicy)" Program.cs
   ```

3. **Authorization files exist**:
   ```bash
   ls Authorization/*.cs | wc -l
   ```
   Should be 2 files.

4. **Account pages exist**:
   ```bash
   ls Components/Pages/Account/*.razor | wc -l
   ```
   Should be 3 files.

5. **Auth endpoints configured**:
   ```bash
   grep -E "(login-google|/account/logout)" Program.cs
   ```
</verification>

<success_criteria>
- Project compiles without errors
- Google OAuth authentication configured with 30-day persistent cookie
- WhitelistedEmailRequirement and WhitelistedEmailHandler created
- FallbackPolicy applies whitelist check to all requests
- Login page with Google button exists
- Logout page with friendly message exists
- AccessDenied page explains whitelist requirement
- MainLayout shows user email and logout link
- Forwarded headers middleware first in pipeline (for nginx)
- Auth endpoints (MapPost, MapGet) configured in Program.cs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>

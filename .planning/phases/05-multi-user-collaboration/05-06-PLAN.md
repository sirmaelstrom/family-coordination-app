---
phase: 05-multi-user-collaboration
plan: 06
type: execute
wave: 4
depends_on: ["05-04", "05-05"]
files_modified:
  - src/FamilyCoordinationApp/Components/Recipes/RecipeCard.razor
  - src/FamilyCoordinationApp/Components/ShoppingList/ShoppingListItemRow.razor
  - src/FamilyCoordinationApp/Components/Pages/Recipes.razor
  - src/FamilyCoordinationApp/Components/Pages/ShoppingList.razor
  - src/FamilyCoordinationApp/Services/RecipeService.cs
  - src/FamilyCoordinationApp/Services/ShoppingListService.cs
autonomous: true

must_haves:
  truths:
    - "Recipe cards show creator avatar and name"
    - "Shopping list items show who added them"
    - "Pages subscribe to DataNotifier and refresh on changes"
    - "Pages properly dispose DataNotifier subscriptions"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Recipes/RecipeCard.razor"
      provides: "Recipe card with creator attribution"
      contains: "UserAvatar"
    - path: "src/FamilyCoordinationApp/Components/ShoppingList/ShoppingListItemRow.razor"
      provides: "Shopping item with adder attribution"
      contains: "UserAvatar"
    - path: "src/FamilyCoordinationApp/Components/Pages/Recipes.razor"
      provides: "Recipe list with DataNotifier subscription"
      contains: "OnRecipesChanged"
  key_links:
    - from: "Recipes.razor"
      to: "DataNotifier.OnRecipesChanged"
      via: "Event subscription in OnInitializedAsync"
      pattern: "Notifier\\.OnRecipesChanged"
    - from: "ShoppingList.razor"
      to: "DataNotifier.OnShoppingListChanged"
      via: "Event subscription in OnInitializedAsync"
      pattern: "Notifier\\.OnShoppingListChanged"
---

<objective>
Add user attribution display to recipes and shopping list items, and integrate DataNotifier subscriptions for automatic refresh.

Purpose: Users see who created/added items and get automatic updates from other family members.
Output: Attribution visible on all content, pages auto-refresh on data changes.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-user-collaboration/05-RESEARCH.md
@.planning/phases/05-multi-user-collaboration/05-04-SUMMARY.md
@.planning/phases/05-multi-user-collaboration/05-05-SUMMARY.md
@src/FamilyCoordinationApp/Components/Recipes/RecipeCard.razor
@src/FamilyCoordinationApp/Components/ShoppingList/ShoppingListItemRow.razor
@src/FamilyCoordinationApp/Components/Pages/Recipes.razor
@src/FamilyCoordinationApp/Components/Pages/ShoppingList.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RecipeService to include CreatedBy in queries</name>
  <files>src/FamilyCoordinationApp/Services/RecipeService.cs</files>
  <action>
Update RecipeService queries to include the CreatedBy navigation property:

In GetRecipesAsync and any other query methods that return recipes:
```csharp
.Include(r => r.CreatedBy)
```

This ensures the User data is loaded for attribution display.

Also update any method that modifies recipes to set UpdatedByUserId.
  </action>
  <verify>RecipeService includes CreatedBy in recipe queries</verify>
  <done>Recipe queries include user attribution data</done>
</task>

<task type="auto">
  <name>Task 2: Update ShoppingListService to include AddedBy in queries</name>
  <files>src/FamilyCoordinationApp/Services/ShoppingListService.cs</files>
  <action>
Update ShoppingListService queries to include the AddedBy navigation property:

In GetActiveShoppingListsAsync and other methods:
```csharp
.Include(sl => sl.Items)
    .ThenInclude(i => i.AddedBy)
```

Also update any method that modifies items to set UpdatedByUserId and UpdatedAt.
  </action>
  <verify>ShoppingListService includes AddedBy in item queries</verify>
  <done>Shopping list queries include user attribution data</done>
</task>

<task type="auto">
  <name>Task 3: Add creator attribution to RecipeCard</name>
  <files>src/FamilyCoordinationApp/Components/Recipes/RecipeCard.razor</files>
  <action>
Add using statement:
```razor
@using FamilyCoordinationApp.Components.Shared
```

Add attribution display in the card (below the recipe name or in the footer):
```razor
@if (Recipe.CreatedBy != null)
{
    <div class="d-flex align-center gap-2 mt-2">
        <UserAvatar User="@Recipe.CreatedBy" Size="Size.Small" />
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            @Recipe.CreatedBy.DisplayName
        </MudText>
    </div>
}
```

Place this in an appropriate location within the card (e.g., at the bottom of the card content).
  </action>
  <verify>RecipeCard shows UserAvatar with creator name</verify>
  <done>Recipe cards display creator attribution</done>
</task>

<task type="auto">
  <name>Task 4: Add adder attribution to ShoppingListItemRow</name>
  <files>src/FamilyCoordinationApp/Components/ShoppingList/ShoppingListItemRow.razor</files>
  <action>
Add using statement:
```razor
@using FamilyCoordinationApp.Components.Shared
```

Add attribution display (subtle, not taking too much space):
```razor
@if (Item.AddedBy != null)
{
    <MudTooltip Text="@($"Added by {Item.AddedBy.DisplayName}")">
        <UserAvatar User="@Item.AddedBy" Size="Size.Small" />
    </MudTooltip>
}
```

Place this in an appropriate location within the row layout (e.g., after the item name or at the end of the row).
  </action>
  <verify>ShoppingListItemRow shows UserAvatar with adder tooltip</verify>
  <done>Shopping list items display adder attribution</done>
</task>

<task type="auto">
  <name>Task 5: Add DataNotifier subscription to Recipes page</name>
  <files>src/FamilyCoordinationApp/Components/Pages/Recipes.razor</files>
  <action>
1. Add inject and implements:
```razor
@using FamilyCoordinationApp.Services
@implements IDisposable

@inject DataNotifier Notifier
```

2. Subscribe to OnRecipesChanged in OnInitializedAsync:
```csharp
protected override async Task OnInitializedAsync()
{
    Notifier.OnRecipesChanged += OnDataChanged;
    // ... existing initialization code
}
```

3. Add handler that refreshes data using InvokeAsync:
```csharp
private void OnDataChanged()
{
    InvokeAsync(async () =>
    {
        await LoadRecipes(); // or whatever the existing load method is called
        StateHasChanged();
    });
}
```

4. Add Dispose:
```csharp
public void Dispose()
{
    Notifier.OnRecipesChanged -= OnDataChanged;
}
```

Note: If the page already implements IAsyncDisposable, convert to IDisposable or add both interfaces.
  </action>
  <verify>Recipes.razor subscribes to DataNotifier, disposes subscription</verify>
  <done>Recipes page auto-refreshes when data changes</done>
</task>

<task type="auto">
  <name>Task 6: Add DataNotifier subscription to ShoppingList page</name>
  <files>src/FamilyCoordinationApp/Components/Pages/ShoppingList.razor</files>
  <action>
1. Add inject (using statement already exists for Services):
```razor
@inject DataNotifier Notifier
```

2. Update to implement IDisposable (may already have IAsyncDisposable, add IDisposable too):
```razor
@implements IDisposable
```

3. Subscribe to OnShoppingListChanged in OnInitializedAsync:
```csharp
protected override async Task OnInitializedAsync()
{
    Notifier.OnShoppingListChanged += OnDataChanged;
    _householdId = await GetHouseholdIdAsync();
    await LoadShoppingListsAsync();
}
```

4. Add handler:
```csharp
private void OnDataChanged()
{
    InvokeAsync(async () =>
    {
        await LoadShoppingListsAsync();
        StateHasChanged();
    });
}
```

5. Update DisposeAsync (or add Dispose if only IAsyncDisposable):
```csharp
public void Dispose()
{
    Notifier.OnShoppingListChanged -= OnDataChanged;
}
```

If both IDisposable and IAsyncDisposable exist, put the unsubscription in Dispose.
  </action>
  <verify>ShoppingList.razor subscribes to DataNotifier, disposes subscription</verify>
  <done>Shopping list page auto-refreshes when data changes</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` - No compilation errors
2. RecipeService.cs includes .Include(r => r.CreatedBy)
3. ShoppingListService.cs includes .Include(sl => sl.Items).ThenInclude(i => i.AddedBy)
4. RecipeCard.razor shows UserAvatar component
5. ShoppingListItemRow.razor shows UserAvatar component
6. Recipes.razor has DataNotifier.OnRecipesChanged subscription and Dispose
7. ShoppingList.razor has DataNotifier.OnShoppingListChanged subscription and Dispose
</verification>

<success_criteria>
- Recipe cards show creator avatar and name
- Shopping list items show who added them (avatar with tooltip)
- Recipes page auto-refreshes when another user makes changes
- Shopping list page auto-refreshes when another user makes changes
- All subscriptions properly disposed to prevent memory leaks
- Solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-user-collaboration/05-06-SUMMARY.md`
</output>

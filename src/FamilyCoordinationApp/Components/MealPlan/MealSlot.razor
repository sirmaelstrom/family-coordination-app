@using FamilyCoordinationApp.Data.Entities

<MudPaper Elevation="@(HasEntries ? 2 : 0)"
          Class="@GetSlotClass()">
    @if (!HasEntries)
    {
        <!-- Empty slot -->
        <div class="slot-empty-content" @onclick="HandleAddClick">
            <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Secondary" Size="Size.Large" />
        </div>
    }
    else
    {
        <!-- Entries list -->
        <div class="slot-entries-container">
            @foreach (var entry in Entries)
            {
                @if (entry.Recipe != null)
                {
                    <!-- Recipe meal -->
                    <div class="slot-entry" @onclick="() => HandleViewRecipe(entry)">
                        @if (!string.IsNullOrWhiteSpace(entry.Recipe.ImagePath))
                        {
                            <img src="@entry.Recipe.ImagePath" alt="@entry.Recipe.Name" class="slot-recipe-image" />
                        }
                        else
                        {
                            <MudTooltip Text="Recipe (no image)">
                                <div class="slot-recipe-placeholder">
                                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" />
                                </div>
                            </MudTooltip>
                        }
                        <div class="slot-recipe-details">
                            <MudText Typo="Typo.body2" Class="slot-recipe-name">
                                @entry.Recipe.Name
                            </MudText>
                            @if (entry.Recipe.RecipeType != RecipeType.Main)
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Class="slot-type-chip">
                                    @entry.Recipe.RecipeType.ToString()
                                </MudChip>
                            }
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                      Size="Size.Small"
                                      Class="slot-remove"
                                      OnClick="() => HandleRemoveEntry(entry)" />
                    </div>
                }
                else if (!string.IsNullOrWhiteSpace(entry.CustomMealName))
                {
                    <!-- Custom meal -->
                    <div class="slot-entry">
                        <MudTooltip Text="Custom meal (not from recipe)">
                            <div class="slot-custom-icon">
                                <MudIcon Icon="@Icons.Material.Filled.Restaurant" Size="Size.Small" />
                            </div>
                        </MudTooltip>
                        <div class="slot-recipe-details">
                            <MudText Typo="Typo.body2" Class="slot-recipe-name">
                                @entry.CustomMealName
                            </MudText>
                            @if (!string.IsNullOrWhiteSpace(entry.Notes))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="slot-notes">
                                    @entry.Notes
                                </MudText>
                            }
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                      Size="Size.Small"
                                      Class="slot-remove"
                                      OnClick="() => HandleRemoveEntry(entry)" />
                    </div>
                }
            }
            <!-- Add more button -->
            <div class="slot-add-more" @onclick="HandleAddClick">
                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">Add side/dessert</MudText>
            </div>
        </div>
    }
</MudPaper>

@code {
    [Parameter]
    public DateOnly Date { get; set; }

    [Parameter]
    public MealType MealType { get; set; }

    [Parameter]
    public List<MealPlanEntry> Entries { get; set; } = new();

    [Parameter]
    public EventCallback OnAddClick { get; set; }

    [Parameter]
    public EventCallback<MealPlanEntry> OnRemoveEntry { get; set; }

    [Parameter]
    public EventCallback<Recipe> OnViewRecipe { get; set; }

    private bool HasEntries => Entries.Any();

    private async Task HandleAddClick()
    {
        await OnAddClick.InvokeAsync();
    }

    private async Task HandleRemoveEntry(MealPlanEntry entry)
    {
        await OnRemoveEntry.InvokeAsync(entry);
    }

    private async Task HandleViewRecipe(MealPlanEntry entry)
    {
        if (entry.Recipe != null)
        {
            await OnViewRecipe.InvokeAsync(entry.Recipe);
        }
    }

    private string GetSlotClass()
    {
        return HasEntries ? "meal-slot" : "meal-slot meal-slot-empty";
    }
}

<style>
    .meal-slot {
        min-height: 80px;
        position: relative;
        transition: background-color 0.2s ease;
        overflow: hidden;
        width: 100%;
    }

    .meal-slot-empty {
        border: 2px dashed var(--mud-palette-lines-default);
        background-color: transparent;
        cursor: pointer;
    }

    .meal-slot-empty:hover {
        background-color: var(--mud-palette-action-default-hover);
    }

    .slot-empty-content {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 80px;
    }

    .slot-entries-container {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 8px;
    }

    .slot-entry {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .slot-entry:hover {
        background-color: var(--mud-palette-action-default-hover);
    }

    .slot-recipe-image {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        flex-shrink: 0;
    }

    .slot-recipe-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--mud-palette-secondary);
        color: var(--mud-palette-secondary-text);
    }

    .slot-custom-icon {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--mud-palette-primary);
        color: var(--mud-palette-primary-text);
    }

    .slot-notes {
        font-style: italic;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .slot-recipe-details {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .slot-recipe-name {
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .slot-type-chip {
        padding: 0 4px !important;
        height: 18px !important;
        font-size: 0.65rem !important;
    }

    .slot-custom-name {
        font-style: italic;
        flex: 1;
    }

    .slot-remove {
        opacity: 0;
        transition: opacity 0.2s ease;
        flex-shrink: 0;
    }

    .slot-entry:hover .slot-remove {
        opacity: 1;
    }

    .slot-add-more {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 6px;
        border: 1px dashed var(--mud-palette-lines-default);
        border-radius: 4px;
        cursor: pointer;
        margin-top: 4px;
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }

    .slot-add-more:hover {
        opacity: 1;
        background-color: var(--mud-palette-action-default-hover);
    }
</style>

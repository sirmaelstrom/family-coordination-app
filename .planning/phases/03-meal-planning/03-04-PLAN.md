---
phase: 03-meal-planning
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - src/FamilyCoordinationApp/Components/Pages/MealPlan.razor
  - src/FamilyCoordinationApp/Components/MealPlan/RecipeDetailDialog.razor
  - src/FamilyCoordinationApp/Components/Layout/NavMenu.razor
autonomous: false

must_haves:
  truths:
    - "User can navigate to meal plan page from nav menu"
    - "User can view weekly meal plan in calendar format on desktop"
    - "User can view weekly meal plan in list format on mobile"
    - "User can click slot to open recipe picker dialog"
    - "User can select recipe and see it appear in slot"
    - "User can enter custom meal and see it appear in slot"
    - "User can remove meal from slot"
    - "User can click recipe to view details in dialog"
    - "User can navigate between weeks"
  artifacts:
    - path: "src/FamilyCoordinationApp/Components/Pages/MealPlan.razor"
      provides: "Main meal plan page with responsive views"
      min_lines: 100
    - path: "src/FamilyCoordinationApp/Components/MealPlan/RecipeDetailDialog.razor"
      provides: "Dialog showing full recipe details"
      min_lines: 30
    - path: "src/FamilyCoordinationApp/Components/Layout/NavMenu.razor"
      provides: "Updated nav with meal plan link"
      contains: "meal-plan"
  key_links:
    - from: "src/FamilyCoordinationApp/Components/Pages/MealPlan.razor"
      to: "IMealPlanService"
      via: "Injection for CRUD"
      pattern: "@inject IMealPlanService"
    - from: "src/FamilyCoordinationApp/Components/Pages/MealPlan.razor"
      to: "IDialogService"
      via: "Injection for dialogs"
      pattern: "@inject IDialogService"
    - from: "src/FamilyCoordinationApp/Components/Pages/MealPlan.razor"
      to: "WeeklyCalendarView/WeeklyListView"
      via: "MudHidden responsive switching"
      pattern: "<MudHidden"
---

<objective>
Create the main MealPlan page that orchestrates all components, add recipe detail dialog, and add navigation link.

Purpose: Complete the meal planning feature by wiring together all components into a functional page with responsive layout switching.

Output: Working meal plan page accessible from navigation, supporting all MEAL-* requirements.
</objective>

<execution_context>
@/home/sirm/.claude/get-shit-done/workflows/execute-plan.md
@/home/sirm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md

# Components to orchestrate
@src/FamilyCoordinationApp/Components/MealPlan/MealPlanNavigation.razor
@src/FamilyCoordinationApp/Components/MealPlan/WeeklyCalendarView.razor
@src/FamilyCoordinationApp/Components/MealPlan/WeeklyListView.razor
@src/FamilyCoordinationApp/Components/MealPlan/RecipePickerDialog.razor

# Service to use
@src/FamilyCoordinationApp/Services/MealPlanService.cs

# Page pattern reference
@src/FamilyCoordinationApp/Components/Pages/Recipes.razor

# Nav menu to update
@src/FamilyCoordinationApp/Components/Layout/NavMenu.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecipeDetailDialog for viewing recipe from meal plan</name>
  <files>src/FamilyCoordinationApp/Components/MealPlan/RecipeDetailDialog.razor</files>
  <action>
Create RecipeDetailDialog.razor for showing full recipe when clicking a meal:

**Parameters:**
- `Recipe Recipe` - The recipe to display

**Layout:** Reuse RecipeCard display pattern in a dialog:

```html
@using FamilyCoordinationApp.Data.Entities
@using Markdig

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@Recipe.Name</MudText>
    </TitleContent>
    <DialogContent>
        @if (!string.IsNullOrWhiteSpace(Recipe.ImagePath))
        {
            <MudImage Src="@Recipe.ImagePath"
                      Alt="@Recipe.Name"
                      ObjectFit="ObjectFit.Cover"
                      Height="200"
                      Class="rounded mb-3"
                      Style="width: 100%;" />
        }

        @if (Recipe.PrepTimeMinutes.HasValue || Recipe.CookTimeMinutes.HasValue || Recipe.Servings.HasValue)
        {
            <div class="d-flex gap-2 flex-wrap mb-3">
                @if (Recipe.PrepTimeMinutes.HasValue)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.Schedule" Size="Size.Small">
                        Prep: @Recipe.PrepTimeMinutes min
                    </MudChip>
                }
                @if (Recipe.CookTimeMinutes.HasValue)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.Whatshot" Size="Size.Small">
                        Cook: @Recipe.CookTimeMinutes min
                    </MudChip>
                }
                @if (Recipe.Servings.HasValue)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.Restaurant" Size="Size.Small">
                        Servings: @Recipe.Servings
                    </MudChip>
                }
            </div>
        }

        @if (Recipe.Ingredients.Any())
        {
            <MudText Typo="Typo.subtitle1" Class="mb-2">Ingredients</MudText>
            <MudList T="string" Dense="true" Class="mb-3">
                @foreach (var ingredient in Recipe.Ingredients.OrderBy(i => i.SortOrder))
                {
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        @FormatIngredient(ingredient)
                    </MudListItem>
                }
            </MudList>
        }

        @if (!string.IsNullOrWhiteSpace(Recipe.Instructions))
        {
            <MudText Typo="Typo.subtitle1" Class="mb-2">Instructions</MudText>
            <div class="recipe-instructions">
                @((MarkupString)Markdown.ToHtml(Recipe.Instructions))
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Recipe Recipe { get; set; } = default!;

    private void Close() => MudDialog.Close();

    private string FormatIngredient(RecipeIngredient ingredient)
    {
        var parts = new List<string>();
        if (ingredient.Quantity.HasValue)
            parts.Add(ingredient.Quantity.Value.ToString("0.##"));
        if (!string.IsNullOrWhiteSpace(ingredient.Unit))
            parts.Add(ingredient.Unit);
        parts.Add(ingredient.Name);
        if (!string.IsNullOrWhiteSpace(ingredient.Notes))
            parts.Add($"({ingredient.Notes})");
        return string.Join(" ", parts);
    }
}
```

Add same CSS as RecipeCard for .recipe-instructions styling.
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
File shows recipe details in dialog format
  </verify>
  <done>
RecipeDetailDialog displays full recipe with ingredients and instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main MealPlan page with responsive views</name>
  <files>src/FamilyCoordinationApp/Components/Pages/MealPlan.razor</files>
  <action>
Create MealPlan.razor page:

```html
@page "/meal-plan"
@using FamilyCoordinationApp.Data.Entities
@using FamilyCoordinationApp.Services
@using FamilyCoordinationApp.Components.MealPlan
@attribute [Authorize]

@inject IMealPlanService MealPlanService
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Meal Plan - Family Coordination</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-4">Meal Plan</MudText>

    <MealPlanNavigation @bind-WeekStartDate="_weekStartDate" />

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="my-4" />
    }
    else
    {
        <!-- Desktop: Calendar Grid (md and up) -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <WeeklyCalendarView WeekStartDate="@_weekStartDate"
                                Entries="@_entries"
                                OnSlotClick="HandleSlotClick"
                                OnRemoveEntry="HandleRemoveEntry"
                                OnViewRecipe="HandleViewRecipe" />
        </MudHidden>

        <!-- Mobile: List View (sm and down) -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <WeeklyListView WeekStartDate="@_weekStartDate"
                            Entries="@_entries"
                            OnSlotClick="HandleSlotClick"
                            OnRemoveEntry="HandleRemoveEntry"
                            OnViewRecipe="HandleViewRecipe" />
        </MudHidden>
    }
</MudContainer>

@code {
    private DateOnly _weekStartDate;
    private List<MealPlanEntry> _entries = new();
    private bool _loading = true;
    private int _householdId;

    protected override async Task OnInitializedAsync()
    {
        // Get current week's Monday
        var today = DateOnly.FromDateTime(DateTime.Today);
        _weekStartDate = MealPlanService.GetWeekStartDate(today);

        // Get household ID from current user
        _householdId = await GetHouseholdIdAsync();

        await LoadMealPlanAsync();
    }

    private async Task<int> GetHouseholdIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        await using var context = await DbFactory.CreateDbContextAsync();
        var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);
        return user?.HouseholdId ?? 1;
    }

    private async Task LoadMealPlanAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var mealPlan = await MealPlanService.GetOrCreateMealPlanAsync(_householdId, _weekStartDate);
            _entries = mealPlan.Entries.ToList();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task HandleWeekChanged(DateOnly newWeekStart)
    {
        _weekStartDate = newWeekStart;
        await LoadMealPlanAsync();
    }

    private async Task HandleSlotClick((DateOnly Date, MealType MealType) slot)
    {
        var parameters = new DialogParameters<RecipePickerDialog>
        {
            { x => x.HouseholdId, _householdId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<RecipePickerDialog>("Select Meal", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is MealSelection selection)
        {
            await MealPlanService.AddMealAsync(
                _householdId,
                slot.Date,
                slot.MealType,
                selection.RecipeId,
                selection.CustomMealName);

            await LoadMealPlanAsync();
        }
    }

    private async Task HandleRemoveEntry(MealPlanEntry entry)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove Meal",
            $"Remove this meal from {entry.Date:MMM d}?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await MealPlanService.RemoveMealAsync(_householdId, entry.MealPlanId, entry.EntryId);
            await LoadMealPlanAsync();
        }
    }

    private async Task HandleViewRecipe(Recipe recipe)
    {
        var parameters = new DialogParameters<RecipeDetailDialog>
        {
            { x => x.Recipe, recipe }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<RecipeDetailDialog>(recipe.Name, parameters, options);
    }
}
```

**Important implementation notes:**
1. Use MudHidden for responsive switching (Breakpoint.SmAndDown for mobile, Breakpoint.MdAndUp for desktop)
2. Both views are always rendered but one is hidden via CSS - this avoids flash on initial load
3. Reload entries after any modification (add or remove)
4. Use DialogParameters<T> with lambda for type-safe parameter passing
5. HandleWeekChanged needs to be wired to MealPlanNavigation via @bind-WeekStartDate
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
File has @page "/meal-plan" route
File uses MudHidden for responsive switching
  </verify>
  <done>
MealPlan page shows calendar on desktop, list on mobile, handles all CRUD operations via dialogs
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Meal Plan link to navigation menu</name>
  <files>src/FamilyCoordinationApp/Components/Layout/NavMenu.razor</files>
  <action>
Update NavMenu.razor to add Meal Plan link:

Add new nav item after Recipes link:

```html
<div class="nav-item px-3">
    <NavLink class="nav-link" href="meal-plan">
        <span class="bi bi-calendar-week-fill-nav-menu" aria-hidden="true"></span> Meal Plan
    </NavLink>
</div>
```

Place it between Recipes and Settings links for logical grouping:
1. Home
2. Recipes
3. Meal Plan (new)
4. Settings

Also remove the Counter and Weather demo links if they still exist (they are placeholders from the template).
  </action>
  <verify>
Build succeeds: `dotnet build src/FamilyCoordinationApp`
NavMenu.razor contains href="meal-plan"
  </verify>
  <done>
Navigation includes Meal Plan link between Recipes and Settings
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete meal planning feature with weekly calendar/list views, recipe assignment, and navigation</what-built>
  <how-to-verify>
1. Start the application: `cd src/FamilyCoordinationApp && dotnet run`
2. Navigate to http://localhost:5000 and sign in
3. Click "Meal Plan" in the navigation menu

**Calendar View (desktop - resize browser to >960px):**
4. Verify 7-day grid with Mon-Sun columns appears
5. Verify Breakfast/Lunch/Dinner rows are visible
6. Click an empty slot - recipe picker dialog should open
7. Search for a recipe by name, select it, click Add
8. Verify recipe appears in the slot with thumbnail
9. Hover over filled slot - verify X remove button appears
10. Click remove button - confirm removal dialog appears
11. Confirm removal - slot should become empty
12. Click "Custom Meal" tab in picker, enter "Leftovers", click Add
13. Verify custom meal appears in italic in the slot

**List View (mobile - resize browser to <960px):**
14. Verify day-by-day expandable panels appear
15. Verify today's panel is expanded by default with "Today" chip
16. Click a slot, add a meal, verify it appears
17. Remove a meal, verify slot becomes empty

**Week Navigation:**
18. Click left arrow - verify previous week loads
19. Click right arrow - verify next week loads
20. Click "Today" button - verify returns to current week
21. Verify week range displayed correctly (e.g., "Jan 20 - Jan 26, 2026")

**Recipe Details:**
22. Click on a recipe name in a filled slot
23. Verify recipe detail dialog opens with ingredients and instructions
24. Close the dialog
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build src/FamilyCoordinationApp` succeeds
2. MealPlan.razor has responsive MudHidden switching
3. RecipeDetailDialog shows full recipe info
4. NavMenu has Meal Plan link
5. All meal planning requirements (MEAL-01 through MEAL-06) are functional
</verification>

<success_criteria>
- User can access meal plan page from navigation
- Desktop shows 7-day grid calendar
- Mobile shows day-by-day list
- User can add recipe or custom meal to any slot
- User can remove meals from slots
- User can view recipe details from meal plan
- Week navigation works correctly
- Human verification confirms all functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-04-SUMMARY.md`
</output>
